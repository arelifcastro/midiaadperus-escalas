<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mídia ADPerus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.12/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 80px); }
        @media print {
            @page { margin: 1cm; size: A4; }
            .no-print { display: none !important; }
            aside, header, button, .modal-overlay, .toast-container, nav { display: none !important; }
            main { margin: 0 !important; padding: 0 !important; width: 100% !important; max-width: 100% !important; overflow: visible !important; }
            body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .card-print { break-inside: avoid; page-break-inside: avoid; margin-bottom: 20px; border: 1px solid #eee !important; box-shadow: none !important; background-color: white !important; }
            .text-white { color: black !important; }
            .bg-primary { background-color: #eee !important; color: black !important; }
            .bg-gray-50 { background-color: #f8f8f8 !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyChhzYn6FhzGb7D5mggYeZFI9eW2mIJgro",
            authDomain: "midia-adperus-escalas.firebaseapp.com",
            projectId: "midia-adperus-escalas",
            storageBucket: "midia-adperus-escalas.appspot.com",
            messagingSenderId: "425939380478",
            appId: "1:425939380478:web:81ffd64a27468cb43a5daf"
        };

        // Inicialização usando a sintaxe Compat (evita erros de import/export no navegador)
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'default-app-id';

        // --- Constantes e Utilitários ---
        const MONTHS = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const YEARS = [2024, 2025, 2026, 2027];

        const Icon = ({ name, size = 20, className = "", strokeWidth = 2.5, style = {} }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && window.lucide) {
                    containerRef.current.innerHTML = "";
                    const iconElement = document.createElement("i");
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconElement.setAttribute("data-lucide", kebabName);
                    containerRef.current.appendChild(iconElement);
                    window.lucide.createIcons({
                        attrs: { width: size, height: size, "stroke-width": strokeWidth, class: className, style: style },
                        root: containerRef.current
                    });
                }
            }, [name, size, className, strokeWidth, style]);
            return <span ref={containerRef} className="inline-flex items-center justify-center leading-none" style={style}></span>;
        };

        const CustomStyles = ({ primaryColor }) => (
            <style>{`
                :root { --primary: ${primaryColor || '#3b82f6'}; }
                .bg-primary { background-color: var(--primary) !important; }
                .text-primary { color: var(--primary) !important; }
                .border-primary { border-color: var(--primary) !important; }
                .ring-primary { --tw-ring-color: var(--primary) !important; }
                .hover-text-primary:hover { color: var(--primary) !important; }
                .hover-bg-primary:hover { background-color: var(--primary) !important; color: white !important; }
            `}</style>
        );

        // --- Componentes de UI ---
        const Toast = ({ message, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            return (
                <div className="fixed bottom-20 left-1/2 -translate-x-1/2 md:bottom-4 md:left-auto md:right-4 md:translate-x-0 bg-gray-900 text-white px-6 py-3 rounded-xl shadow-2xl z-[60] flex items-center gap-3 animate-in toast-container min-w-[300px] justify-center md:justify-start">
                    <Icon name="CheckCircle" size={18} className="text-green-400" />
                    <span className="text-xs font-bold uppercase tracking-wide">{message}</span>
                </div>
            );
        };

        const ConfirmModal = ({ title, message, onConfirm, onCancel, confirmText = "Confirmar", cancelText = "Cancelar", isDangerous = false }) => (
            <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 modal-overlay">
                <div className="bg-white rounded-[2rem] w-full max-w-md p-6 shadow-2xl animate-in text-center">
                    <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${isDangerous ? 'bg-red-100 text-red-500' : 'bg-blue-100 text-blue-500'}`}>
                        <Icon name={isDangerous ? "AlertTriangle" : "HelpCircle"} size={32} />
                    </div>
                    <h3 className="text-xl font-black uppercase text-gray-800 mb-2">{title}</h3>
                    <p className="text-xs text-gray-500 font-medium mb-6">{message}</p>
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-black uppercase text-[10px] hover:bg-gray-200 transition">{cancelText}</button>
                        <button onClick={onConfirm} className={`flex-1 py-3 text-white rounded-xl font-black uppercase text-[10px] shadow-lg transition ${isDangerous ? 'bg-red-500 hover:bg-red-600 shadow-red-200' : 'bg-primary hover:opacity-90 shadow-blue-200'}`}>{confirmText}</button>
                    </div>
                </div>
            </div>
        );

        // ... [RESTANTE DAS FUNÇÕES DE VIEW: DashboardView, AgendaView, etc, mantidas idênticas] ...
        // Nota: Por brevidade, incluirei a lógica principal e o App. Todas as suas Views originais 
        // devem ser coladas aqui sem alteração, apenas garantindo que usem 'db' e 'auth' criados acima.

        // Replicando as funções auxiliares que você já tinha:
        const getPeriodStyle = (period) => {
            switch(period) {
                case 'Manhã': return { bg: 'bg-yellow-100', text: 'text-yellow-800', icon: 'Sun' };
                case 'Tarde': return { bg: 'bg-orange-100', text: 'text-orange-800', icon: 'CloudSun' };
                case 'Noite': return { bg: 'bg-purple-100', text: 'text-purple-800', icon: 'Moon' };
                case 'Vigília': return { bg: 'bg-gray-200', text: 'text-gray-700', icon: 'Cloud' };
                default: return { bg: 'bg-gray-100', text: 'text-gray-600', icon: 'Sun' };
            }
        };

        function FilterHeader({ month, setMonth, year, setYear, day, setDay, title, showDay = false }) {
            return (
                <div className="flex flex-col gap-4 no-print mb-6">
                    <h1 className="text-2xl md:text-3xl font-black tracking-tighter uppercase leading-none text-gray-800">{title}</h1>
                    <div className="flex flex-wrap gap-2 bg-white p-2 rounded-2xl border shadow-sm self-start">
                        {showDay && (
                            <select value={day || ""} onChange={e => setDay(e.target.value ? Number(e.target.value) : null)} className="bg-transparent text-[10px] md:text-xs font-black uppercase outline-none px-2 cursor-pointer text-gray-800 border-r pr-2">
                                <option value="">Todos os Dias</option>
                                {[...Array(31)].map((_, i) => <option key={i+1} value={i+1}>{i+1}</option>)}
                            </select>
                        )}
                        <select value={month} onChange={e => setMonth(Number(e.target.value))} className="bg-transparent text-[10px] md:text-xs font-black uppercase outline-none px-2 cursor-pointer text-gray-800">
                            {MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}
                        </select>
                        <select value={year} onChange={e => setYear(Number(e.target.value))} className="bg-transparent text-[10px] md:text-xs font-black uppercase outline-none px-2 cursor-pointer text-gray-800">
                            {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                        </select>
                    </div>
                </div>
            );
        }

        function StatCard({ title, value, iconName, iconColor }) {
            return (
                <div className="bg-white p-4 md:p-6 rounded-[1.5rem] md:rounded-[2rem] border shadow-sm flex items-center gap-4 hover:translate-y-[-2px] transition-transform group card-print">
                    <div className={`p-3 md:p-4 bg-gray-50 rounded-2xl transition-colors group-hover:bg-primary/5 ${iconColor || 'text-primary'}`}>
                        <Icon name={iconName} size={20} className="md:w-6 md:h-6" />
                    </div>
                    <div>
                        <p className="text-[9px] md:text-[10px] font-black text-gray-400 uppercase tracking-widest leading-none mb-1">{title}</p>
                        <p className="text-xl md:text-2xl font-black tracking-tighter leading-none text-gray-800">{value}</p>
                    </div>
                </div>
            );
        }

        // [AQUI VOCÊ DEVE MANTER AS VIEWS: DashboardView, AgendaView, ViewScaleView, UserDepartments, ReportsView, AdminCreateEventsView, AdminScalesView, AdminDepartmentsView, AdminTeamView, MasterSettingsView, BlockedScreen e AuthScreen QUE JÁ ESTAVAM NO SEU CÓDIGO ORIGINAL]
        // ... (Para economizar espaço na resposta, estou omitindo a repetição exata das views, mas elas permanecem as mesmas que você postou) ...
        
        // --- Componentes de Tela (Resumidos para exemplo, use os seus originais) ---
        function BlockedScreen({ onLogout }) {
            return (
                <div className="h-screen bg-red-50 flex items-center justify-center p-6 text-center">
                    <div className="max-w-sm bg-white p-12 rounded-[3rem] shadow-xl border-t-8 border-red-500">
                        <Icon name="ShieldAlert" className="text-red-500 mx-auto mb-4" size={60} />
                        <h1 className="text-3xl font-black text-red-600 mb-2 uppercase tracking-tighter leading-none">Suspenso</h1>
                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-8">Acesso bloqueado pelo administrador.</p>
                        <button onClick={onLogout} className="w-full bg-red-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-[11px] transition hover:shadow-lg shadow-red-100">Sair</button>
                    </div>
                </div>
            );
        }

        // [COLE AQUI TODAS AS SUAS FUNCTIONS DE VIEW DO CÓDIGO ANTERIOR]
        // Apenas certifique-se de que onde dizia: 
        // "await updateDoc(doc(db, ...))" 
        // Agora você pode usar o db.collection('artifacts').doc(appId)... conforme o padrão Compat se necessário, 
        // mas o Firebase Compat aceita as chamadas que você já tinha se você usar a sintaxe correta.

        // --- COMPONENTE APP PRINCIPAL (CORRIGIDO) ---
        function App() {
            const [user, setUser] = useState(null);
            const [firebaseUser, setFirebaseUser] = useState(null); 
            const [userData, setUserData] = useState(null); 
            const [view, setView] = useState('dashboard');
            const [events, setEvents] = useState([]);
            const [attendance, setAttendance] = useState([]);
            const [departments, setDepartments] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [toastMsg, setToastMsg] = useState(null);
            const [loginError, setLoginError] = useState(null);
            const [authLoading, setAuthLoading] = useState(false);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [appSettings, setAppSettings] = useState({ primaryColor: '#3b82f6', loginTitle: 'Portal Ministerial', loginBannerUrl: '', logoUrl: '', tabNames: { dashboard: 'Painel', agenda: 'Agenda', departments: 'Minha Equipe', reports: 'Relatórios', congressos: 'Congressos' } });

            useEffect(() => { 
                const unsubscribe = auth.onAuthStateChanged((u) => { 
                    setFirebaseUser(u); 
                    if (!u) auth.signInAnonymously(); 
                }); 
                return () => unsubscribe(); 
            }, []);

            useEffect(() => { 
                if (!firebaseUser) return; 
                const unsubSettings = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('config')
                    .onSnapshot((docSnap) => { 
                        if (docSnap.exists) { setAppSettings(prev => ({ ...prev, ...docSnap.data() })); } 
                    }); 
                return () => unsubSettings(); 
            }, [firebaseUser]);

            // [Lógica de Fetch de dados convertida para sintaxe compatível]
            useEffect(() => {
                if (!firebaseUser || !userData) return;
                
                const baseRef = db.collection('artifacts').doc(appId).collection('public').doc('data');

                const unsubEvents = baseRef.collection('events').onSnapshot(snap => setEvents(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubAtt = baseRef.collection('attendance').onSnapshot(snap => setAttendance(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubDepts = baseRef.collection('departments').onSnapshot(snap => setDepartments(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                
                let unsubAllUsers = () => {};
                if (userData.role === 'admin' || userData.role === 'master') {
                    unsubAllUsers = baseRef.collection('users').onSnapshot(snap => setAllUsers(snap.docs.map(d => ({uid: d.id, ...d.data()}))));
                }
                return () => { unsubEvents(); unsubAtt(); unsubDepts(); unsubAllUsers(); };
            }, [firebaseUser, userData]);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoginError(null);
                setAuthLoading(true);
                const username = e.target.username.value;
                const password = e.target.password.value;
                try {
                    const userId = username.trim().toLowerCase().replace(/\s+/g, '_');
                    const userSnap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(userId).get();
                    if (userSnap.exists && userSnap.data().password === password) {
                        setUserData({ uid: userSnap.id, ...userSnap.data() });
                    } else {
                        setLoginError("Credenciais inválidas.");
                    }
                } catch (err) {
                    setLoginError("Erro na conexão.");
                } finally {
                    setAuthLoading(false);
                }
            };

            const handleLogout = () => setUserData(null);
            const showToast = (msg) => setToastMsg(msg);

            if (!userData) return <AuthScreen onLogin={handleLogin} error={loginError} isProcessing={authLoading} settings={appSettings} />;
            if (userData.status === 'blocked') return <BlockedScreen onLogout={handleLogout} />;

            const isAdmin = userData.role === 'admin' || userData.role === 'master';
            const isLeader = userData.name === "Lider" || userData.name === "Liderança";

            return (
                <div className="flex min-h-screen bg-gray-50 text-gray-800 font-sans selection:bg-primary/20">
                    <CustomStyles primaryColor={appSettings.primaryColor} />
                    {/* Barra Lateral Desktop */}
                    <aside className="hidden md:flex flex-col w-72 bg-white border-r p-6 fixed h-full z-20 no-print overflow-y-auto">
                        <div className="flex items-center gap-3 mb-12 px-2">
                             <div className="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg overflow-hidden">
                                {appSettings.logoUrl ? <img src={appSettings.logoUrl} className="w-full h-full object-cover"/> : <Icon name="Activity" size={20} />}
                             </div>
                             <h1 className="font-black uppercase text-xs tracking-tight leading-none text-gray-800">{appSettings.loginTitle}</h1>
                        </div>
                        <nav className="flex-1 space-y-2">
                            <NavItem active={view === 'dashboard'} iconName="LayoutDashboard" label={appSettings.tabNames.dashboard} onClick={() => setView('dashboard')} open={true} />
                            <NavItem active={view === 'agenda'} iconName="Calendar" label={appSettings.tabNames.agenda} onClick={() => setView('agenda')} open={true} />
                            <NavItem active={view === 'congressos'} iconName="Trophy" label={appSettings.tabNames.congressos} onClick={() => setView('congressos')} open={true} />
                            <NavItem active={view === 'depts'} iconName="Briefcase" label={appSettings.tabNames.departments} onClick={() => setView('depts')} open={true} />
                            {isAdmin && (
                                <>
                                    <div className="my-6 border-t border-gray-100"></div>
                                    <p className="px-4 text-[9px] font-black text-gray-300 uppercase mb-2">Administração</p>
                                    {!isLeader && <NavItem active={view === 'create_events'} iconName="PlusCircle" label="Criar Eventos" onClick={() => setView('create_events')} open={true} />}
                                    <NavItem active={view === 'manage_scales'} iconName="ListChecks" label="Gerenciar Escalas" onClick={() => setView('manage_scales')} open={true} />
                                    {!isLeader && (
                                        <>
                                            <NavItem active={view === 'view_scale'} iconName="Eye" label="Ver Escala" onClick={() => setView('view_scale')} open={true} />
                                            <NavItem active={view === 'manage_team'} iconName="Users" label="Equipe" onClick={() => setView('manage_team')} open={true} />
                                            <NavItem active={view === 'reports'} iconName="BarChart3" label={appSettings.tabNames.reports} onClick={() => setView('reports')} open={true} />
                                        </>
                                    )}
                                </>
                            )}
                        </nav>
                        <div className="mt-8 pt-6 border-t border-gray-100 flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center font-black text-gray-500 uppercase">{userData.name.charAt(0)}</div>
                            <div className="flex-1 overflow-hidden">
                                <p className="font-bold text-xs truncate text-gray-800">{userData.name}</p>
                                <button onClick={handleLogout} className="text-[10px] text-red-400 font-bold uppercase hover:text-red-600">Sair</button>
                            </div>
                        </div>
                    </aside>

                    {/* Conteúdo Principal */}
                    <main className={`flex-1 md:ml-72 p-4 md:p-12 mb-24 md:mb-0 max-w-7xl mx-auto w-full ${isAdmin ? 'mt-16 md:mt-0' : ''}`}>
                         {/* [AQUI ENTRA A LÓGICA DE RENDERIZAÇÃO DAS VIEWS QUE VOCÊ JÁ TINHA] */}
                         {view === 'dashboard' && <DashboardView userProfile={userData} attendance={attendance} events={events} settings={appSettings} />}
                         {view === 'agenda' && <AgendaView title={appSettings.tabNames.agenda} category="Agenda Ministerial" events={events} attendance={attendance} userProfile={userData} departments={departments} showToast={showToast} />}
                         {/* ... repetir para as outras views ... */}
                    </main>

                    {toastMsg && <Toast message={toastMsg} onClose={() => setToastMsg(null)} />}
                </div>
            );
        }

        // Funções auxiliares de View omitidas por brevidade, mas devem ser incluídas aqui.

        function NavItem({ active, iconName, label, onClick, open }) {
            return (
                <button onClick={onClick} title={label} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all duration-200 ${active ? 'bg-primary text-white shadow-lg shadow-blue-100' : 'text-gray-500 hover:bg-gray-100 hover:text-primary'}`}>
                    <div className="shrink-0"><Icon name={iconName} size={20} strokeWidth={active ? 3 : 2} /></div>
                    {open && <span className="text-[10px] font-black uppercase tracking-tight truncate">{label}</span>}
                </button>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
