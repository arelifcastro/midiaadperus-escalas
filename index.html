<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Ministerial - Mídia ADPerus</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        @media print {
            .no-print { display: none !important; }
            aside, header, button, .modal-overlay { display: none !important; }
            main { margin: 0 !important; padding: 0 !important; width: 100% !important; overflow: visible !important; }
            .print-container { display: block !important; padding: 20px !important; }
            .card-print { border: 1px solid #eee !important; break-inside: avoid; margin-bottom: 15px; }
            .bg-gray-50 { background-color: white !important; }
            .text-primary { color: black !important; border-bottom: 2px solid var(--primary); }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Configuração Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, signOut, signInWithCustomToken, signInAnonymously 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, updateDoc, collection, onSnapshot, 
            addDoc, deleteDoc, getDocs, query, where 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyChhzYn6FhzGb7D5mggYeZFI9eW2mIJgro",
            authDomain: "midia-adperus-escalas.firebaseapp.com",
            projectId: "midia-adperus-escalas",
            storageBucket: "midia-adperus-escalas.appspot.com",
            messagingSenderId: "425939380478",
            appId: "1:425939380478:web:81ffd64a27468cb43a5daf",
            measurementId: "G-SH421MT1FC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'midia-adperus-escalas';

        const MONTHS = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const YEARS = [2024, 2025, 2026, 2027];

        // --- Componente de Ícone Corrigido ---
        const Icon = ({ name, size = 20, className = "", strokeWidth = 2 }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current && window.lucide) {
                    // Limpa o conteúdo anterior para evitar duplicatas ou erros de renderização
                    containerRef.current.innerHTML = "";
                    const iconElement = document.createElement("i");
                    // Converte camelCase para kebab-case (ex: LayoutDashboard -> layout-dashboard)
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconElement.setAttribute("data-lucide", kebabName);
                    containerRef.current.appendChild(iconElement);

                    window.lucide.createIcons({
                        attrs: {
                            width: size,
                            height: size,
                            "stroke-width": strokeWidth,
                            class: className
                        },
                        root: containerRef.current
                    });
                }
            }, [name, size, className, strokeWidth]);

            return <span ref={containerRef} className="inline-flex items-center justify-center leading-none"></span>;
        };

        const CustomStyles = ({ primaryColor }) => (
            <style>{`
                :root { --primary: ${primaryColor || '#3b82f6'}; }
                .bg-primary { background-color: var(--primary) !important; }
                .text-primary { color: var(--primary) !important; }
                .border-primary { border-color: var(--primary) !important; }
                .ring-primary { --tw-ring-color: var(--primary) !important; }
                .hover-bg-primary:hover { background-color: var(--primary); opacity: 0.9; }
            `}</style>
        );

        // --- COMPONENTES AUXILIARES ---

        function FilterHeader({ month, setMonth, year, setYear, title }) {
            return (
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 no-print mb-6">
                    <h1 className="text-3xl font-black tracking-tighter uppercase leading-none text-gray-800">{title}</h1>
                    <div className="flex gap-2 bg-white p-2 rounded-2xl border shadow-sm">
                        <select value={month} onChange={e => setMonth(Number(e.target.value))} className="bg-transparent text-[10px] font-black uppercase outline-none px-2 cursor-pointer text-gray-800">
                            {MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}
                        </select>
                        <select value={year} onChange={e => setYear(Number(e.target.value))} className="bg-transparent text-[10px] font-black uppercase outline-none px-2 cursor-pointer text-gray-800">
                            {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                        </select>
                    </div>
                </div>
            );
        }

        function StatCard({ title, value, iconName, iconColor }) {
            return (
                <div className="bg-white p-6 rounded-[2rem] border shadow-sm flex items-center gap-4 hover:translate-y-[-2px] transition-transform group card-print text-gray-800">
                    <div className={`p-4 bg-gray-50 rounded-2xl transition-colors group-hover:bg-primary/5 ${iconColor || 'text-primary'}`}>
                        <Icon name={iconName} size={24} />
                    </div>
                    <div>
                        <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest leading-none mb-1">{title}</p>
                        <p className="text-2xl font-black tracking-tighter leading-none">{value}</p>
                    </div>
                </div>
            );
        }

        function NavItem({ active, iconName, label, onClick, open }) {
            return (
                <button onClick={onClick} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all duration-200 ${
                    active ? 'bg-primary text-white shadow-lg shadow-blue-100' : 'text-gray-500 hover:bg-gray-100 hover:text-primary'
                }`}>
                    <div className="shrink-0">
                        <Icon name={iconName} size={20} strokeWidth={active ? 3 : 2} />
                    </div>
                    {open && <span className="text-[10px] font-black uppercase tracking-tight">{label}</span>}
                </button>
            );
        }

        function StatItem({ title, value, iconName, colorClass }) {
            return (
                <div className="bg-white p-6 rounded-[2.5rem] border shadow-sm flex flex-col items-center justify-center text-center card-print text-gray-800">
                   <div className={`mb-3 ${colorClass}`}>
                       <Icon name={iconName} size={32} />
                   </div>
                   <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest leading-none mb-1">{title}</p>
                   <p className={`text-4xl font-black leading-none tracking-tighter ${colorClass}`}>{value}</p>
                </div>
            );
        }

        // --- TELAS DE ACESSO ---

        function PendingScreen({ onLogout }) {
            return (
                <div className="h-screen bg-gray-50 flex items-center justify-center p-6 text-center text-gray-800">
                    <div className="max-w-sm bg-white p-12 rounded-[3rem] shadow-xl border border-gray-100">
                        <Icon name="Clock" className="text-yellow-500 mx-auto mb-4" size={60} />
                        <h1 className="text-3xl font-black mb-2 uppercase tracking-tighter leading-none">Aguardando</h1>
                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-8">Cadastro em análise. Fale com um administrador.</p>
                        <button onClick={onLogout} className="w-full py-4 rounded-2xl border-2 border-gray-100 font-black text-[10px] text-gray-400 hover:text-red-500 uppercase tracking-widest transition-all">Sair</button>
                    </div>
                </div>
            );
        }

        function BlockedScreen({ onLogout }) {
            return (
                <div className="h-screen bg-red-50 flex items-center justify-center p-6 text-center text-gray-800">
                    <div className="max-w-sm bg-white p-12 rounded-[3rem] shadow-xl border-t-8 border-red-500">
                        <Icon name="ShieldAlert" className="text-red-500 mx-auto mb-4" size={60} />
                        <h1 className="text-3xl font-black text-red-600 mb-2 uppercase tracking-tighter leading-none">Suspenso</h1>
                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-8">Acesso bloqueado por segurança.</p>
                        <button onClick={onLogout} className="w-full bg-red-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-[11px] transition hover:shadow-lg shadow-red-100">Sair</button>
                    </div>
                </div>
            );
        }

        function AuthScreen({ onLogin, onRegister, onAdminLogin, error, isProcessing, settings }) {
            const [mode, setMode] = useState('login');
            const [selectedUnidade, setSelectedUnidade] = useState("");

            const bannerBg = settings.loginBannerUrl 
                ? { backgroundImage: `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url(${settings.loginBannerUrl})`, backgroundSize: 'cover', backgroundPosition: 'center' }
                : { backgroundColor: settings.loginBgColor || settings.primaryColor };

            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans text-gray-800">
                    <CustomStyles primaryColor={settings.primaryColor} />
                    <div className="max-w-4xl w-full bg-white rounded-[3rem] shadow-2xl overflow-hidden flex flex-col md:flex-row border border-gray-100">
                        <div className="md:w-1/2 p-12 text-white flex flex-col justify-center relative overflow-hidden text-center transition-all duration-700" style={bannerBg}>
                            {!settings.loginBannerUrl && <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-32 -mt-32"></div>}
                            <div className="relative z-10">
                                <div className="w-24 h-24 mx-auto mb-6 bg-white/10 rounded-full flex items-center justify-center overflow-hidden border-2 border-white/20">
                                    {settings.logoUrl ? (
                                        <img src={settings.logoUrl} className="w-full h-full object-cover" alt="Logo" />
                                    ) : settings.loginIconUrl ? (
                                        <img src={settings.loginIconUrl} className="w-full h-full object-cover" alt="Icon" />
                                    ) : (
                                        <Icon name="Crown" size={48} className="opacity-80 text-white" />
                                    )}
                                </div>
                                <h1 className="text-4xl font-black mb-2 uppercase leading-none tracking-tighter text-white drop-shadow-lg">
                                    {settings.loginTitle || "Mídia ADPerus"}
                                </h1>
                            </div>
                        </div>
                        <div className="md:w-1/2 p-12 overflow-y-auto max-h-[90vh]">
                            <div className="flex gap-2 mb-8 bg-gray-100 p-1.5 rounded-2xl">
                                <button onClick={() => setMode('login')} className={`flex-1 py-2.5 text-[10px] font-black uppercase rounded-xl transition-all duration-300 ${mode === 'login' ? 'bg-primary text-white shadow-md' : 'text-gray-400 hover:text-gray-600'}`}>Entrar</button>
                                <button onClick={() => setMode('register')} className={`flex-1 py-2.5 text-[10px] font-black uppercase rounded-xl transition-all duration-300 ${mode === 'register' ? 'bg-primary text-white shadow-md' : 'text-gray-400 hover:text-gray-600'}`}>Criar</button>
                                <button onClick={() => setMode('admin')} className={`flex-1 py-2.5 text-[10px] font-black uppercase rounded-xl transition-all duration-300 ${mode === 'admin' ? 'bg-purple-600 text-white shadow-md' : 'text-gray-400 hover:text-gray-600'}`}>Admin</button>
                            </div>
                            
                            <form onSubmit={mode === 'admin' ? onAdminLogin : mode === 'login' ? onLogin : onRegister} className="space-y-4 text-gray-800">
                                {mode === 'login' && (
                                    <div className="space-y-4 animate-in fade-in">
                                        <div className="relative"><Icon name="UserCircle" className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" /><input name="name" placeholder="Usuário" required className="w-full pl-12 pr-4 py-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-primary/20 transition text-gray-800" /></div>
                                        <div className="relative"><Icon name="Lock" className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" /><input name="password" type="password" placeholder="Senha" required className="w-full pl-12 pr-4 py-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-primary/20 transition text-gray-800" /></div>
                                    </div>
                                )}
                                
                                {mode === 'register' && (
                                    <div className="space-y-3 animate-in fade-in">
                                        <div className="relative"><Icon name="User" className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" /><input name="name" placeholder="Nome Completo" required className="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                        <div className="relative"><Icon name="Phone" className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" /><input name="phone" placeholder="WhatsApp" required className="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                        <div className="relative text-gray-800"><Icon name="MapPin" className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" /><select name="unidadeType" defaultValue="" required onChange={(e) => setSelectedUnidade(e.target.value)} className="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-xl outline-none font-bold text-xs border-2 border-transparent focus:border-primary/20"><option value="" disabled>Igreja: Regional, Setor ou Congregação?</option><option value="Regional">Regional</option><option value="Setor">Setor</option><option value="Congregação">Congregação</option></select></div>

                                        {(selectedUnidade === "Regional" || selectedUnidade === "Setor" || selectedUnidade === "Congregação") && (
                                           <div className="relative animate-in slide-in-from-top-1"><Icon name="Church" className="absolute left-4 top-1/2 -translate-y-1/2 text-primary" /><input name="regionalName" placeholder="Nome da Regional" required className="w-full pl-12 pr-4 py-3 bg-white border-2 border-primary/20 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                        )}
                                        {(selectedUnidade === "Setor" || selectedUnidade === "Congregação") && (
                                          <div className="relative animate-in slide-in-from-top-1"><Icon name="Layers" className="absolute left-4 top-1/2 -translate-y-1/2 text-primary" /><input name="setorName" placeholder="Nome do Setor" required className="w-full pl-12 pr-4 py-3 bg-white border-2 border-primary/20 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                        )}
                                        {selectedUnidade === "Congregação" && (
                                          <div className="relative animate-in slide-in-from-top-1"><Icon name="Building" className="absolute left-4 top-1/2 -translate-y-1/2 text-primary" /><input name="congregacaoName" placeholder="Nome da Congregação" required className="w-full pl-12 pr-4 py-3 bg-white border-2 border-primary/20 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                        )}

                                        <div className="relative text-gray-800"><Icon name="Lock" className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" /><input name="password" type="password" placeholder="Criar Senha (mín. 6)" required className="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                    </div>
                                )}
                                
                                {mode === 'admin' && (
                                    <div className="relative animate-in fade-in"><Icon name="ShieldAlert" className="absolute left-4 top-1/2 -translate-y-1/2 text-purple-400" /><input name="adminPassword" type="password" placeholder="Senha Master" required className="w-full pl-12 pr-4 py-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-purple-200 transition text-gray-800" /></div>
                                )}
                                
                                {error && <div className="p-4 bg-red-50 text-red-600 rounded-2xl text-[10px] font-black uppercase flex items-center gap-2 animate-in slide-in-from-top-2"><Icon name="AlertCircle" size={14}/> {error}</div>}
                                
                                <button 
                                    type="submit" 
                                    disabled={isProcessing} 
                                    className={`w-full ${mode === 'admin' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-primary hover:opacity-90'} text-white py-5 rounded-[1.5rem] font-black shadow-xl uppercase tracking-widest text-[11px] transition-all active:scale-95 shadow-blue-100 flex items-center justify-center`}
                                    style={{ color: '#ffffff' }}
                                >
                                    {isProcessing ? "Aguarde..." : mode === 'login' ? "Entrar" : mode === 'register' ? "Cadastrar Agora" : "Acessar Master"}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // --- VISÕES DE CONTEÚDO ---

        function DashboardView({ userProfile, attendance, events }) {
            const [month, setMonth] = useState(new Date().getMonth());
            const [year, setYear] = useState(new Date().getFullYear());

            const filteredAtt = useMemo(() => attendance.filter(a => {
                const d = new Date(a.timestamp);
                return a.userId === userProfile.uid && d.getMonth() === Number(month) && d.getFullYear() === Number(year);
            }), [attendance, userProfile.uid, month, year]);

            const stats = {
                available: filteredAtt.filter(a => a.status === 'present').length,
                unavailable: filteredAtt.filter(a => a.status === 'absent').length,
                escalated: filteredAtt.filter(a => a.isEscalated).length,
                pending: events.filter(e => new Date(e.date) > new Date()).length
            };

            return (
                <div className="space-y-6 text-gray-800">
                    <FilterHeader title="Visão Geral" month={month} setMonth={setMonth} year={year} setYear={setYear} />
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="Disponível" value={stats.available} iconName="CheckCircle" iconColor="text-green-500" />
                        <StatCard title="Indisponível" value={stats.unavailable} iconName="XCircle" iconColor="text-red-500" />
                        <StatCard title="Escalado" value={stats.escalated} iconName="ClipboardCheck" iconColor="text-purple-500" />
                        <StatCard title="Eventos Futuros" value={stats.pending} iconName="Clock" iconColor="text-blue-500" />
                    </div>
                    <div className="bg-white p-8 rounded-[2.5rem] border shadow-sm text-gray-800">
                        <h2 className="text-xl font-black uppercase tracking-tighter mb-6 flex items-center gap-2 text-gray-800"><Icon name="FileText" className="text-primary" /> Histórico Ministerial</h2>
                        <div className="divide-y divide-gray-50">
                            {filteredAtt.map(a => (
                                <div key={a.id} className="py-4 flex justify-between items-center text-gray-800">
                                    <div>
                                        <p className="font-bold uppercase text-xs">{a.eventName}</p>
                                        <p className="text-[10px] text-gray-400 font-black uppercase tracking-tight">{a.servingDept} • {new Date(a.timestamp).toLocaleDateString()}</p>
                                    </div>
                                    <span className={`px-3 py-1 rounded-lg text-[9px] font-black uppercase ${a.status === 'present' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                        {a.status === 'present' ? "Disponível" : "Ausente"}
                                    </span>
                                </div>
                            ))}
                            {filteredAtt.length === 0 && <p className="py-10 text-center text-gray-300 font-bold uppercase text-[10px]">Nenhum registro encontrado</p>}
                        </div>
                    </div>
                </div>
            );
        }

        function AgendaView({ events, attendance, userProfile, departments, category, showToast }) {
            const [activeTab, setActiveTab] = useState('semanal');
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [expandedEvent, setExpandedEvent] = useState(null);

            const filteredEvents = useMemo(() => events.filter(ev => {
                const d = new Date(ev.date);
                if (d.getUTCMonth() !== Number(filterMonth) || d.getUTCFullYear() !== Number(filterYear)) return false;
                if (ev.category !== category && !(ev.category === undefined && category === "Agenda Ministerial")) return false;
                if (activeTab === 'sábados') return d.getUTCDay() === 6;
                if (activeTab === 'domingos') return d.getUTCDay() === 0;
                return d.getUTCDay() !== 0 && d.getUTCDay() !== 6;
            }).sort((a,b) => new Date(a.date) - new Date(b.date)), [events, activeTab, filterMonth, filterYear, category]);

            const respond = async (event, status, deptName = 'INDISPONÍVEL') => {
                const attId = `${event.id}_${userProfile.uid}`;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', attId), {
                    id: attId, eventId: event.id, eventName: event.name, eventDate: event.date, eventCategory: category,
                    userId: userProfile.uid, userName: userProfile.name, servingDept: deptName,
                    status: status, isEscalated: false, timestamp: new Date().toISOString()
                });
                setExpandedEvent(null);
                showToast("Confirmado!");
            };

            return (
                <div className="space-y-6 text-gray-800">
                    <FilterHeader title={category} month={filterMonth} setMonth={setFilterMonth} year={filterYear} setYear={setFilterYear} />
                    <div className="flex gap-2 bg-white p-1 rounded-2xl border shadow-sm w-fit no-print">
                        {['semanal', 'sábados', 'domingos'].map(t => <button key={t} onClick={() => setActiveTab(t)} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${activeTab === t ? 'bg-primary text-white shadow-lg' : 'text-gray-400'}`}>{t}</button>)}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-gray-800">
                        {filteredEvents.map(ev => {
                            const myAtt = attendance.find(a => a.eventId === ev.id && a.userId === userProfile.uid);
                            const isReady = ev.scaleStatus === 'ready';
                            return (
                                <div key={ev.id} className="bg-white rounded-[2.5rem] border p-8 shadow-sm hover:border-primary transition-all flex flex-col card-print text-gray-800">
                                    <div className="flex items-center justify-between mb-4">
                                        <div className={`p-4 rounded-2xl text-white shadow-lg ${isReady ? 'bg-gray-800' : 'bg-primary'}`}>
                                            <p className="text-[10px] font-black uppercase opacity-60">Dia</p>
                                            <p className="text-2xl font-black leading-none">{new Date(ev.date).getUTCDate()}</p>
                                        </div>
                                        {isReady && <span className="bg-green-100 text-green-600 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest">Escala Pronta</span>}
                                    </div>

                                    <h3 className="text-xl font-black uppercase mb-6 leading-tight text-gray-800">{ev.name}</h3>

                                    <div className="space-y-3 mb-8">
                                        <div className="flex items-center gap-3 text-gray-400">
                                            <Icon name="Clock" size={16} className="text-primary" />
                                            <div>
                                                <p className="text-[9px] font-black uppercase tracking-widest leading-none mb-1">Horário</p>
                                                <p className="text-xs font-bold text-gray-700">{ev.time}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3 text-gray-400">
                                            <Icon name="Calendar" size={16} className="text-primary" />
                                            <div>
                                                <p className="text-[9px] font-black uppercase tracking-widest leading-none mb-1">Período</p>
                                                <p className="text-xs font-bold text-gray-700">{ev.period || "Não informado"}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3 text-gray-400">
                                            <Icon name="MapPin" size={16} className="text-primary" />
                                            <div>
                                                <p className="text-[9px] font-black uppercase tracking-widest leading-none mb-1">Local</p>
                                                <p className="text-xs font-bold text-gray-700">{ev.location || "Não informado"}</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="no-print mt-auto pt-6 border-t border-gray-50">
                                        {myAtt ? (
                                            <div className="space-y-4">
                                                <div className={`p-4 rounded-2xl text-center border-2 font-black uppercase text-xs shadow-sm flex flex-col gap-1 ${myAtt.status === 'present' ? 'bg-green-50 border-green-100 text-green-700' : 'bg-red-50 border-red-100 text-red-700'}`}>
                                                    <span className="text-[9px] opacity-60">Sua Resposta:</span>
                                                    <span>{myAtt.status === 'present' ? `Servindo: ${myAtt.servingDept}` : 'Indisponível'}</span>
                                                </div>
                                                {!isReady && (
                                                    <button onClick={() => setExpandedEvent(ev.id)} className="w-full text-[10px] font-black text-gray-400 uppercase tracking-widest hover:text-primary transition-colors">
                                                        Alterar Resposta
                                                    </button>
                                                )}
                                            </div>
                                        ) : expandedEvent === ev.id ? (
                                            <div className="space-y-2 animate-in slide-in-from-bottom-2">
                                                <p className="text-[9px] font-black uppercase text-gray-400 mb-2">Onde vai servir?</p>
                                                {departments.filter(d => userProfile.participatingDepts?.includes(d.id) || userProfile.role === 'master').map(d => (
                                                    <button key={d.id} onClick={() => respond(ev, 'present', d.name)} className="w-full p-3 border-2 rounded-xl text-[10px] font-black uppercase transition-all hover:bg-gray-50" style={{ borderColor: `${d.color}40`, color: d.color }}>{d.name}</button>
                                                ))}
                                                <button onClick={() => respond(ev, 'absent')} className="w-full p-3 bg-red-50 text-red-600 rounded-xl text-[10px] font-black uppercase border-2 border-transparent">Indisponível</button>
                                                <button onClick={() => setExpandedEvent(null)} className="w-full text-[10px] font-black text-gray-300 mt-2 uppercase tracking-widest">Cancelar</button>
                                            </div>
                                        ) : (
                                            <button onClick={() => setExpandedEvent(ev.id)} className="w-full py-4 bg-primary text-white rounded-2xl font-black text-[11px] uppercase shadow-lg shadow-blue-100 hover:scale-[1.02] transition-all">Confirmar Disponibilidade</button>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                        {filteredEvents.length === 0 && <p className="col-span-full py-20 text-center text-gray-300 font-black uppercase text-xs border-2 border-dashed rounded-[3rem]">Nenhum evento para este período.</p>}
                    </div>
                </div>
            );
        }

        function UserDepartments({ departments, userProfile }) {
            const [month, setMonth] = useState(new Date().getMonth());
            const [year, setYear] = useState(new Date().getFullYear());
            
            const myDepts = useMemo(() => departments.filter(d => userProfile.participatingDepts?.includes(d.id)), [departments, userProfile.participatingDepts]);
            
            return (
                <div className="space-y-6 text-gray-800">
                    <FilterHeader title="Minhas Frentes" month={month} setMonth={setMonth} year={year} setYear={setYear} />
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-gray-800">
                        {myDepts.map(d => (
                            <div key={d.id} className="bg-white p-8 rounded-[2.5rem] border-l-8 shadow-sm relative overflow-hidden group text-gray-800" style={{ borderLeftColor: d.color }}>
                                <div className="flex justify-between items-start mb-6">
                                    <div className="p-3 rounded-2xl overflow-hidden shadow-sm" style={{ backgroundColor: `${d.color}20`, color: d.color }}>
                                         {d.icon && d.icon.startsWith('data:image') ? <img src={d.icon} className="w-8 h-8 object-cover" alt="Icon" /> : <Icon name="Briefcase" size={24} />}
                                    </div>
                                    <span className="text-[10px] font-black text-green-500 uppercase tracking-widest">Ativo</span>
                                </div>
                                <h3 className="text-xl font-black uppercase tracking-tight mb-2 leading-none text-gray-800">{d.name}</h3>
                                <p className="text-[10px] font-black text-primary uppercase mb-4 tracking-widest leading-none">Líder: {d.leader}</p>
                                <p className="text-xs text-gray-400 font-medium leading-relaxed">{d.description}</p>
                            </div>
                        ))}
                        {myDepts.length === 0 && <p className="col-span-full py-20 text-center text-gray-300 font-black uppercase text-xs border-2 border-dashed rounded-[3rem]">Você não participa de frentes de trabalho.</p>}
                    </div>
                </div>
            );
        }

        function ReportsView({ attendance, allUsers, departments }) {
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [memberSearch, setMemberSearch] = useState('');
            const [selectedMember, setSelectedMember] = useState(null);

            const filteredData = useMemo(() => attendance.filter(a => {
                const d = new Date(a.timestamp);
                return d.getMonth() === Number(filterMonth) && d.getFullYear() === Number(filterYear);
            }), [attendance, filterMonth, filterYear]);

            const stats = useMemo(() => {
                const total = filteredData.length;
                const present = filteredData.filter(a => a.status === 'present').length;
                return {
                    rate: total > 0 ? ((present / total) * 100).toFixed(0) : 0,
                    escalated: filteredData.filter(a => a.isEscalated).length,
                    agenda: filteredData.filter(a => a.eventCategory !== "Congressos" && a.status === 'present').length,
                    congress: filteredData.filter(a => a.eventCategory === "Congressos" && a.status === 'present').length
                };
            }, [filteredData]);

            const deptStats = useMemo(() => departments.map(d => {
                const atts = filteredData.filter(a => a.servingDept === d.name);
                const present = atts.filter(a => a.status === 'present').length;
                return { name: d.name, color: d.color, rate: atts.length > 0 ? ((present / atts.length) * 100).toFixed(0) : 0 };
            }).sort((a,b) => b.rate - a.rate), [filteredData, departments]);

            return (
                <div className="space-y-8 text-gray-800 pb-20">
                    <FilterHeader title="Relatórios" month={filterMonth} setMonth={setFilterMonth} year={filterYear} setYear={setFilterYear} />

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatItem title="Disponibilidade" value={`${stats.rate}%`} iconName="PieChart" colorClass="text-primary" />
                        <StatItem title="Agenda Ministerial" value={stats.agenda} iconName="BookOpen" colorClass="text-blue-600" />
                        <StatItem title="Congressos" value={stats.congress} iconName="Trophy" colorClass="text-orange-600" />
                        <StatItem title="Vezes Escalados" value={stats.escalated} iconName="UserCheck" colorClass="text-green-600" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 text-gray-800">
                        <div className="bg-white rounded-[2.5rem] border shadow-sm overflow-hidden flex flex-col no-print">
                            <div className="p-8 border-b bg-gray-50 text-gray-800">
                               <h3 className="text-lg font-black uppercase tracking-tighter flex items-center gap-2 text-gray-800"><Icon name="SearchCode" size={20} className="text-primary"/> Analisar Membro</h3>
                               <input type="text" placeholder="Nome do membro..." className="w-full mt-4 p-4 bg-white rounded-2xl border-2 border-transparent focus:border-primary outline-none font-bold text-sm shadow-sm text-gray-800" value={memberSearch} onChange={e => setMemberSearch(e.target.value)} />
                            </div>
                            <div className="flex-1 p-4 max-h-60 overflow-y-auto space-y-2">
                               {memberSearch && allUsers.filter(u => u.name.toLowerCase().includes(memberSearch.toLowerCase())).map(u => (
                                  <button key={u.uid} onClick={() => setSelectedMember(u)} className={`w-full p-4 rounded-2xl text-left border-2 transition-all flex justify-between items-center ${selectedMember?.uid === u.uid ? 'border-primary bg-primary/5' : 'border-gray-50 bg-white'}`}>
                                     <span className="font-bold text-xs uppercase tracking-tight text-gray-800">{u.name}</span>
                                     <Icon name="ChevronRight" size={14} className="text-gray-300" />
                                  </button>
                               ))}
                            </div>
                            {selectedMember && (
                               <div className="p-8 bg-primary/5 border-t space-y-4">
                                  <div className="flex items-center gap-3">
                                     <div className="w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center font-black uppercase shadow-lg">{selectedMember.name.charAt(0)}</div>
                                     <p className="font-black uppercase text-sm text-gray-800">{selectedMember.name}</p>
                                  </div>
                                  <div className="grid grid-cols-2 gap-4">
                                    <div className="p-4 bg-white rounded-xl text-center"><p className="text-[10px] font-black text-gray-400 uppercase">Escalas</p><p className="text-xl font-black text-primary">{filteredData.filter(a => a.userId === selectedMember.uid && a.isEscalated).length}</p></div>
                                    <div className="p-4 bg-white rounded-xl text-center"><p className="text-[10px] font-black text-gray-400 uppercase">Presenças</p><p className="text-xl font-black text-green-600">{filteredData.filter(a => a.userId === selectedMember.uid && a.status === 'present').length}</p></div>
                                  </div>
                               </div>
                            )}
                        </div>

                        <div className="bg-white rounded-[2.5rem] border shadow-sm p-8 flex flex-col card-print text-gray-800">
                            <h3 className="text-lg font-black uppercase tracking-tighter mb-6 flex items-center gap-2 text-gray-800"><Icon name="Briefcase" size={20} className="text-primary"/> Ranking de Frentes</h3>
                            <div className="space-y-4 overflow-y-auto max-h-[500px] pr-2">
                               {deptStats.map(d => (
                                  <div key={d.name} className="p-4 bg-gray-50 rounded-[1.5rem] border border-transparent group">
                                     <div className="flex justify-between items-center mb-2">
                                        <span className="text-[10px] font-black uppercase tracking-tight" style={{ color: d.color }}>{d.name}</span>
                                        <span className="text-[10px] font-black text-gray-400 uppercase">{d.rate}% engajamento</span>
                                     </div>
                                     <div className="w-full h-3 bg-gray-200 rounded-full overflow-hidden shadow-inner"><div className="h-full transition-all duration-1000 ease-out" style={{ width: `${d.rate}%`, backgroundColor: d.color }}></div></div>
                                  </div>
                               ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- ADMIN FEATURES ---

        function DepartmentsAdmin({ departments, showToast }) {
            const [showAdd, setShowAdd] = useState(false);
            const [editing, setEditing] = useState(null);
            const [iconPreview, setIconPreview] = useState('');
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setIconPreview(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = async (e) => {
                e.preventDefault();
                const data = new FormData(e.target);
                const payload = { 
                    name: data.get('name'), 
                    leader: data.get('leader'), 
                    description: data.get('description'), 
                    color: data.get('color'), 
                    icon: iconPreview || editing?.icon || '',
                    createdAt: editing?.createdAt || new Date().toISOString()
                };
                if (editing) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'departments', editing.id), payload);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'departments'), payload);
                setEditing(null); setShowAdd(false); setIconPreview('');
                showToast("Salvo!");
            };

            return (
                <div className="space-y-6 text-gray-800">
                    <FilterHeader title="Frentes" month={filterMonth} setMonth={setFilterMonth} year={filterYear} setYear={setFilterYear} />
                    <div className="flex justify-end mb-4">
                        <button onClick={() => { setShowAdd(true); setIconPreview(''); }} className="bg-primary text-white p-4 rounded-2xl font-black shadow-lg flex items-center gap-2 text-white"><Icon name="Plus" size={20}/> Novo</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {departments.map(d => (
                            <div key={d.id} className="bg-white p-6 rounded-[2rem] border shadow-sm flex items-center justify-between group">
                                <div className="flex items-center gap-4 text-gray-800">
                                    <div className="w-12 h-12 rounded-2xl flex items-center justify-center overflow-hidden shadow-sm" style={{ backgroundColor: `${d.color}20`, color: d.color }}>
                                        {d.icon && d.icon.startsWith('data:image') ? <img src={d.icon} className="w-full h-full object-cover" alt="Icon" /> : <Icon name="Briefcase" size={24}/>}
                                    </div>
                                    <div><h4 className="font-black uppercase text-sm text-gray-800">{d.name}</h4><p className="text-[10px] font-black text-gray-400 uppercase">Líder: {d.leader}</p></div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => { setEditing(d); setIconPreview(d.icon); }} className="p-2 text-gray-400 hover:text-primary transition"><Icon name="Edit2" size={18}/></button>
                                    <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'departments', d.id))} className="p-2 text-gray-400 hover:text-red-500 transition"><Icon name="Trash2" size={18}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                    {(showAdd || editing) && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <form onSubmit={handleSave} className="bg-white p-8 rounded-[3rem] w-full max-w-md space-y-4 text-gray-800 shadow-2xl overflow-y-auto max-h-[90vh]">
                                <div className="flex flex-col items-center gap-4 py-2 border-b">
                                    <div className="w-20 h-20 rounded-3xl bg-gray-50 border-2 border-dashed border-gray-200 flex items-center justify-center relative overflow-hidden group">
                                        {iconPreview ? <img src={iconPreview} className="w-full h-full object-cover" alt="Preview" /> : <Icon name="Image" className="text-gray-300" />}
                                        <input type="file" onChange={handleFileChange} className="absolute inset-0 opacity-0 cursor-pointer text-gray-800" accept="image/*" />
                                    </div>
                                </div>
                                <input name="name" defaultValue={editing?.name} placeholder="Nome" required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800" />
                                <input name="leader" defaultValue={editing?.leader} placeholder="Líder" required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800" />
                                <textarea name="description" defaultValue={editing?.description} placeholder="Descrição" className="w-full p-4 bg-gray-50 rounded-2xl font-medium outline-none h-24 text-gray-800" />
                                <input name="color" type="color" defaultValue={editing?.color || "#3b82f6"} className="w-full h-12 bg-transparent cursor-pointer" />
                                <div className="flex gap-4 pt-4 text-gray-800">
                                    <button type="button" onClick={() => {setShowAdd(false); setEditing(null); setIconPreview('');}} className="flex-1 text-xs font-black uppercase text-gray-400">Cancelar</button>
                                    <button type="submit" className="flex-1 bg-primary text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg text-white">Salvar</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        function EventsAdmin({ events, attendance, departments, allUsers, showToast }) {
            const [showAdd, setShowAdd] = useState(false);
            const [editing, setEditing] = useState(null);
            const [m, setM] = useState(new Date().getMonth());
            const [y, setY] = useState(new Date().getFullYear());
            const [scaleBuildingState, setScaleBuildingState] = useState(null); 
            const [availabilityDetail, setAvailabilityDetail] = useState(null);

            const filteredEvents = useMemo(() => events.filter(ev => {
                const d = new Date(ev.date);
                return d.getUTCMonth() === Number(m) && d.getUTCFullYear() === Number(y);
            }).sort((a,b) => new Date(a.date) - new Date(b.date)), [events, m, y]);

            const handleSave = async (e) => {
                e.preventDefault();
                const data = new FormData(e.target);
                const payload = { 
                    name: data.get('name'), date: data.get('date'), time: data.get('time'), 
                    period: data.get('period'), location: data.get('location'), 
                    category: data.get('category'), scaleStatus: editing?.scaleStatus || 'draft' 
                };
                if (editing) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', editing.id), payload);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'events'), payload);
                setEditing(null); setShowAdd(false);
                showToast("Salvo!");
            };

            const markReady = async (ev, status) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', ev.id), { scaleStatus: status ? 'ready' : 'draft' });
                setScaleBuildingState(null);
            };

            const toggleEscalated = async (att) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', att.id), { isEscalated: !att.isEscalated });
            };

            const getAvailabilityStats = (eventId) => {
                const eventAttendance = attendance.filter(a => a.eventId === eventId);
                const presentCount = eventAttendance.filter(a => a.status === 'present').length;
                return presentCount;
            };

            return (
                <div className="space-y-6 text-gray-800">
                    <FilterHeader title="Cronograma" month={m} setMonth={setM} year={y} setYear={setY} />
                    <div className="flex justify-end mb-4">
                        <button onClick={() => setShowAdd(true)} className="bg-primary text-white p-4 rounded-2xl font-black shadow-lg flex items-center gap-2 text-white uppercase text-xs shadow-blue-100"><Icon name="Plus" size={20}/> Novo</button>
                    </div>
                    <div className="bg-white rounded-[2.5rem] border overflow-hidden shadow-sm">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-gray-800">
                                <thead className="bg-gray-50 text-[10px] font-black uppercase tracking-widest border-b text-gray-800">
                                    <tr>
                                        <th className="px-8 py-4">Evento</th>
                                        <th className="px-8 py-4 text-center">Status</th>
                                        <th className="px-8 py-4 text-center">Disponibilidade</th>
                                        <th className="px-8 py-4 text-right">Ações</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100 text-gray-800">
                                    {filteredEvents.map(ev => (
                                        <tr key={ev.id} className="hover:bg-gray-50/50 transition group">
                                            <td className="px-8 py-4 text-gray-800">
                                                <p className="font-black text-sm uppercase text-gray-800">{ev.name}</p>
                                                <p className="text-[9px] font-bold text-gray-400 uppercase">{new Date(ev.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p>
                                            </td>
                                            <td className="px-8 py-4 text-center">
                                                <div className="flex items-center justify-center gap-2">
                                                    <span className={`px-3 py-1 rounded-lg text-[9px] font-black uppercase ${ev.scaleStatus === 'ready' ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'}`}>
                                                        {ev.scaleStatus === 'ready' ? 'Ativa' : 'Rascunho'}
                                                    </span>
                                                    <button onClick={() => setScaleBuildingState({ event: ev, step: 'depts' })} className="text-primary hover:underline text-[10px] font-black uppercase">Montar</button>
                                                </div>
                                            </td>
                                            <td className="px-8 py-4 text-center">
                                                <button 
                                                    onClick={() => setAvailabilityDetail(ev)}
                                                    className="bg-gray-50 px-4 py-2 rounded-xl text-[10px] font-black uppercase text-gray-500 border border-transparent hover:border-primary transition-all flex items-center gap-2 mx-auto"
                                                >
                                                    <Icon name="Users" size={14} />
                                                    {getAvailabilityStats(ev.id)} Voluntários
                                                </button>
                                            </td>
                                            <td className="px-8 py-4 text-right">
                                                <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => setEditing(ev)} className="p-2 text-gray-400 hover:text-primary transition"><Icon name="Edit2" size={18}/></button>
                                                    <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', ev.id))} className="p-2 text-gray-400 hover:text-red-500 transition"><Icon name="Trash2" size={18}/></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                    {filteredEvents.length === 0 && <tr><td colSpan="4" className="py-10 text-center text-gray-400 text-xs font-bold uppercase">Nenhum evento neste período</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Modal Detalhado de Disponibilidade */}
                    {availabilityDetail && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] text-gray-800">
                                <div className="p-8 border-b bg-gray-50 flex justify-between items-center shrink-0">
                                    <div>
                                        <h2 className="text-2xl font-black uppercase text-gray-800">Quem respondeu?</h2>
                                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{availabilityDetail.name}</p>
                                    </div>
                                    <button onClick={() => setAvailabilityDetail(null)} className="p-3 bg-white rounded-full text-gray-800 shadow-sm hover:text-red-500 transition-colors"><Icon name="X" size={24} /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-8 space-y-8">
                                    {departments.map(dept => {
                                        const eventAtt = attendance.filter(a => a.eventId === availabilityDetail.id);
                                        const availableInDept = eventAtt.filter(a => a.servingDept === dept.name && a.status === 'present');
                                        const unavailableInDept = eventAtt.filter(a => a.servingDept === dept.name && a.status === 'absent');
                                        
                                        const respondedUids = eventAtt.map(a => a.userId);
                                        const pendingInDept = allUsers.filter(u => u.participatingDepts?.includes(dept.id) && !respondedUids.includes(u.uid));

                                        return (
                                            <div key={dept.id} className="space-y-4">
                                                <div className="flex items-center gap-3 border-b-2 pb-2" style={{ borderColor: `${dept.color}20` }}>
                                                    <div className="w-2 h-8 rounded-full" style={{ backgroundColor: dept.color }}></div>
                                                    <h3 className="font-black uppercase text-sm" style={{ color: dept.color }}>{dept.name}</h3>
                                                </div>
                                                
                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div className="space-y-2">
                                                        <p className="text-[9px] font-black uppercase text-green-500">Disponíveis ({availableInDept.length})</p>
                                                        <div className="flex flex-col gap-1">
                                                            {availableInDept.map(a => (
                                                                <div key={a.userId} className="p-2 bg-green-50 rounded-lg text-[10px] font-bold text-green-700 uppercase flex items-center gap-2">
                                                                    <div className="w-1.5 h-1.5 rounded-full bg-green-400"></div>
                                                                    {a.userName}
                                                                </div>
                                                            ))}
                                                            {availableInDept.length === 0 && <p className="text-[9px] text-gray-300 italic">Ninguém</p>}
                                                        </div>
                                                    </div>

                                                    <div className="space-y-2">
                                                        <p className="text-[9px] font-black uppercase text-red-500">Ausentes ({unavailableInDept.length})</p>
                                                        <div className="flex flex-col gap-1">
                                                            {unavailableInDept.map(a => (
                                                                <div key={a.userId} className="p-2 bg-red-50 rounded-lg text-[10px] font-bold text-red-700 uppercase flex items-center gap-2">
                                                                    <div className="w-1.5 h-1.5 rounded-full bg-red-400"></div>
                                                                    {a.userName}
                                                                </div>
                                                            ))}
                                                            {unavailableInDept.length === 0 && <p className="text-[9px] text-gray-300 italic">Ninguém</p>}
                                                        </div>
                                                    </div>

                                                    <div className="space-y-2">
                                                        <p className="text-[9px] font-black uppercase text-gray-400">Pendentes ({pendingInDept.length})</p>
                                                        <div className="flex flex-col gap-1">
                                                            {pendingInDept.map(u => (
                                                                <div key={u.uid} className="p-2 bg-gray-50 rounded-lg text-[10px] font-bold text-gray-400 uppercase flex items-center gap-2">
                                                                    <div className="w-1.5 h-1.5 rounded-full bg-gray-300"></div>
                                                                    {u.name}
                                                                </div>
                                                            ))}
                                                            {pendingInDept.length === 0 && <p className="text-[9px] text-gray-300 italic">Todos responderam</p>}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {scaleBuildingState && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] text-gray-800">
                                <div className="p-8 border-b bg-gray-50 flex justify-between items-center shrink-0">
                                    <div><h2 className="text-2xl font-black uppercase text-gray-800">{scaleBuildingState.step === 'depts' ? "Escolher Frente" : `Escalar: ${scaleBuildingState.dept.name}`}</h2></div>
                                    <button onClick={() => setScaleBuildingState(null)} className="p-3 bg-white rounded-full text-gray-800 shadow-sm"><Icon name="X" size={24} /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-8">
                                  {scaleBuildingState.step === 'depts' ? (
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-800">
                                            {departments.map(dept => (
                                                <button key={dept.id} onClick={() => setScaleBuildingState({ ...scaleBuildingState, dept, step: 'members' })} className="w-full p-6 rounded-[2rem] border-2 transition-all text-left flex items-center gap-4 bg-gray-50 border-transparent hover:border-primary text-gray-800 shadow-sm">
                                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center shrink-0 shadow-sm" style={{ backgroundColor: `${dept.color}20`, color: dept.color }}>
                                                        {dept.icon && dept.icon.startsWith('data:image') ? <img src={dept.icon} className="w-full h-full object-cover rounded-lg" alt="Icon" /> : <Icon name="Briefcase" size={20}/>}
                                                    </div>
                                                    <div className="flex-1"><p className="font-black uppercase text-xs tracking-tight text-gray-800">{dept.name}</p></div>
                                                </button>
                                            ))}
                                        </div>
                                        <button onClick={() => markReady(scaleBuildingState.event, scaleBuildingState.event.scaleStatus !== 'ready')} className={`w-full py-5 rounded-[2rem] font-black uppercase text-xs tracking-widest transition-all text-white shadow-xl ${scaleBuildingState.event.scaleStatus === 'ready' ? 'bg-orange-500' : 'bg-green-600'}`}>
                                            {scaleBuildingState.event.scaleStatus === 'ready' ? "Reverter Rascunho" : "Publicar Escala Agora"}
                                        </button>
                                    </div>
                                  ) : (
                                    <div className="space-y-6">
                                        <button onClick={() => setScaleBuildingState({ ...scaleBuildingState, step: 'depts' })} className="flex items-center gap-2 text-[10px] font-black text-primary uppercase transition-colors hover:text-primary/60">
                                            <Icon name="ChevronDown" className="rotate-90" size={14} /> Voltar
                                        </button>
                                        {attendance.filter(a => a.eventId === scaleBuildingState.event.id && a.servingDept === scaleBuildingState.dept.name && a.status === 'present').map(att => (
                                            <div key={att.id} className={`p-4 bg-white border-2 rounded-2xl flex items-center justify-between transition-all ${att.isEscalated ? 'border-green-200 bg-green-50/20' : 'border-gray-100 bg-gray-50/30'}`}>
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-black uppercase shadow-sm ${att.isEscalated ? 'bg-green-500' : 'bg-gray-300'}`}>{att.userName.charAt(0)}</div>
                                                    <p className="font-black uppercase text-sm tracking-tight text-gray-700">{att.userName}</p>
                                                </div>
                                                <button onClick={() => toggleEscalated(att)} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase transition-all text-white shadow-md ${att.isEscalated ? 'bg-green-600' : 'bg-primary'}`}>
                                                    {att.isEscalated ? "Remover" : "Confirmar"}
                                                </button>
                                            </div>
                                        ))}
                                        {attendance.filter(a => a.eventId === scaleBuildingState.event.id && a.servingDept === scaleBuildingState.dept.name && a.status === 'present').length === 0 && (
                                            <p className="py-20 text-center text-gray-300 font-bold uppercase text-[10px]">Ninguém disponível para esta frente</p>
                                        )}
                                    </div>
                                  )}
                                </div>
                            </div>
                        </div>
                    )}
                    {(showAdd || editing) && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <form onSubmit={handleSave} className="bg-white p-8 rounded-[3rem] w-full max-w-md space-y-4 text-gray-800 shadow-2xl overflow-y-auto max-h-[90vh]">
                                <h2 className="text-2xl font-black uppercase text-gray-800">Evento</h2>
                                <select name="category" defaultValue={editing?.category || 'Agenda Ministerial'} className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-primary text-gray-800">
                                    <option value="Agenda Ministerial">Agenda Ministerial</option>
                                    <option value="Congressos">Congressos</option>
                                </select>
                                <input name="name" defaultValue={editing?.name} placeholder="Nome" required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800" />
                                <div className="grid grid-cols-2 gap-2">
                                    <input name="date" type="date" defaultValue={editing?.date} required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800" />
                                    <input name="time" type="time" defaultValue={editing?.time} required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800" />
                                </div>
                                <input name="location" defaultValue={editing?.location} placeholder="Local" required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800" />
                                <input name="period" defaultValue={editing?.period} placeholder="Período" required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800" />
                                <div className="flex gap-4 pt-4">
                                    <button type="button" onClick={() => {setShowAdd(false); setEditing(null)}} className="flex-1 text-xs font-black uppercase text-gray-400">Cancelar</button>
                                    <button type="submit" className="flex-1 bg-primary text-white py-4 rounded-2xl font-black uppercase text-xs text-white shadow-lg">Salvar</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        function MembersAdmin({ allUsers, departments, showToast }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [editingUser, setEditingUser] = useState(null);
            const [selectedDepts, setSelectedDepts] = useState([]);

            const filtered = useMemo(() => allUsers.filter(u => {
                const matchesSearch = u.name?.toLowerCase().includes(searchTerm.toLowerCase());
                const d = u.joinDate ? new Date(u.joinDate) : null;
                const matchesDate = !d || (d.getMonth() === Number(filterMonth) && d.getFullYear() === Number(filterYear));
                return matchesSearch && matchesDate;
            }), [allUsers, searchTerm, filterMonth, filterYear]);

            const toggleDept = (id) => setSelectedDepts(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);

            const handleSave = async (e) => {
                e.preventDefault();
                const data = new FormData(e.target);
                const payload = { 
                    name: data.get('name'), phone: data.get('phone'), 
                    unidadeType: data.get('unidadeType'), regionalName: data.get('regionalName'), 
                    setorName: data.get('setorName'), congregacaoName: data.get('congregacaoName'), 
                    role: data.get('role'), status: data.get('status'), 
                    isAdmin: data.get('role') !== 'user', participatingDepts: selectedDepts, 
                    isAvailable: data.get('isAvailable') === 'true' 
                };
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingUser.uid), payload);
                setEditingUser(null);
                showToast("Sucesso!");
            };

            return (
                <div className="space-y-6 text-gray-800">
                    <FilterHeader title="Voluntários" month={filterMonth} setMonth={setFilterMonth} year={filterYear} setYear={setFilterYear} />
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 no-print text-gray-800">
                        <div className="relative flex-1 md:w-64 text-gray-800">
                            <Icon name="Search" className="absolute left-3 top-3 text-gray-400" size={18} />
                            <input type="text" placeholder="Pesquisar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-white rounded-xl border border-gray-100 outline-none font-bold text-xs text-gray-800" />
                        </div>
                    </div>
                    <div className="bg-white rounded-[2.5rem] border overflow-hidden shadow-sm">
                        <div className="overflow-x-auto text-gray-800">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 text-[10px] font-black uppercase tracking-widest border-b text-gray-800">
                                    <tr><th className="px-8 py-4">Membro</th><th className="px-8 py-4 text-center">Status</th><th className="px-8 py-4 text-right">Ações</th></tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100 text-gray-800">
                                    {filtered.map(u => (
                                        <tr key={u.uid} className="hover:bg-gray-50/50 group text-gray-800">
                                            <td className="px-8 py-4 font-bold text-gray-800">
                                                <p className="font-black text-sm uppercase text-gray-800">{u.name}</p>
                                                <p className="text-[8px] font-bold text-gray-400 uppercase">{u.unidadeType}: {u.regionalName}</p>
                                            </td>
                                            <td className="px-8 py-4 text-center">
                                                <span className={`px-3 py-1 rounded-lg text-[9px] font-black uppercase ${u.status === 'active' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                                    {u.status === 'active' ? "Ativo" : u.status === 'pending' ? "Pendente" : "Bloqueado"}
                                                </span>
                                            </td>
                                            <td className="px-8 py-4 text-right text-gray-800">
                                                <button onClick={() => {setEditingUser(u); setSelectedDepts(u.participatingDepts || []);}} className="p-2 text-gray-400 hover:text-primary transition opacity-0 group-hover:opacity-100">
                                                    <Icon name="Edit2" size={16}/>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                    {filtered.length === 0 && <tr><td colSpan="3" className="py-10 text-center text-gray-400 text-xs font-bold uppercase">Nenhum membro neste período</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {editingUser && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <form onSubmit={handleSave} className="bg-white p-8 rounded-[3rem] w-full max-w-lg space-y-4 shadow-2xl overflow-y-auto max-h-[90vh] text-gray-800">
                                <h2 className="text-2xl font-black uppercase text-gray-800">Perfil do Usuário</h2>
                                <div className="grid grid-cols-2 gap-4 text-gray-800">
                                    <input name="name" defaultValue={editingUser?.name} placeholder="Nome" required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800" />
                                    <input name="phone" defaultValue={editingUser?.phone} placeholder="WhatsApp" required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800" />
                                    <select name="role" defaultValue={editingUser?.role || "user"} className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800">
                                        <option value="user">Membro</option>
                                        <option value="admin">Administrador</option>
                                        <option value="master">Master</option>
                                    </select>
                                    <select name="status" defaultValue={editingUser?.status || "active"} className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800">
                                        <option value="active">Ativo</option>
                                        <option value="pending">Pendente</option>
                                        <option value="blocked">Bloqueado</option>
                                    </select>
                                    <select name="isAvailable" defaultValue={editingUser?.isAvailable ? 'true' : 'false'} className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800">
                                        <option value="true">Disponível</option>
                                        <option value="false">Indisponível</option>
                                    </select>
                                    <select name="unidadeType" defaultValue={editingUser?.unidadeType} className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none text-gray-800">
                                        <option value="Regional">Regional</option>
                                        <option value="Setor">Setor</option>
                                        <option value="Congregação">Congregação</option>
                                    </select>
                                </div>
                                <div className="pt-4 border-t text-gray-800">
                                    <p className="text-[10px] font-black uppercase mb-4 text-gray-400">Departamentos/Frentes:</p>
                                    <div className="grid grid-cols-2 gap-2 text-gray-800">
                                        {departments.map(d => (
                                            <button key={d.id} type="button" onClick={() => toggleDept(d.id)} className={`p-3 rounded-xl border-2 flex items-center justify-between transition-all ${selectedDepts.includes(d.id) ? 'bg-primary/5 border-primary text-primary' : 'bg-gray-50 border-transparent text-gray-400'}`}>
                                                <span className="text-[9px] font-black uppercase">{d.name}</span>
                                                {selectedDepts.includes(d.id) && <Icon name="Check" size={14} />}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex gap-4 pt-6 text-gray-800">
                                    <button type="button" onClick={() => setEditingUser(null)} className="flex-1 text-xs font-black uppercase text-gray-400 hover:text-red-500">Cancelar</button>
                                    <button type="submit" className="flex-1 bg-primary text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg text-white">Salvar</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        function SettingsAdminView({ settings, onUpdate, showToast }) {
            const [iconPreview, setIconPreview] = useState(settings.loginIconUrl || '');
            const [portalIconPreview, setPortalIconPreview] = useState(settings.logoUrl || '');

            const handleIconUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { 
                        setIconPreview(reader.result); 
                        onUpdate({ ...settings, loginIconUrl: reader.result }); 
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handlePortalIconUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { 
                        setPortalIconPreview(reader.result); 
                        onUpdate({ ...settings, logoUrl: reader.result }); 
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="max-w-2xl mx-auto bg-white p-10 rounded-[3rem] border shadow-sm space-y-8 text-gray-800">
                    <h2 className="text-2xl font-black text-primary flex items-center gap-2 uppercase tracking-tighter leading-none text-gray-800"><Icon name="Palette" /> Personalizar Portal</h2>
                    <div className="space-y-6">
                        <div>
                            <label className="text-[10px] font-black text-gray-400 uppercase mb-2 block tracking-widest text-gray-400">Nome do Portal</label>
                            <input value={settings.siteName} onChange={e => onUpdate({...settings, siteName: e.target.value})} className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-primary transition text-gray-800 shadow-sm" />
                        </div>
                        <div>
                            <label className="text-[10px] font-black text-gray-400 uppercase mb-2 block tracking-widest text-gray-400">Ícone do Portal (Upload)</label>
                            <div className="flex items-center gap-4 text-gray-800">
                                <div className="w-16 h-16 rounded-2xl bg-gray-50 border-2 border-dashed border-gray-200 flex items-center justify-center overflow-hidden">
                                    {portalIconPreview ? <img src={portalIconPreview} className="w-full h-full object-cover" alt="Portal Icon" /> : <Icon name="Image" className="text-gray-300" />}
                                </div>
                                <label className="flex-1">
                                    <div className="p-4 bg-gray-50 rounded-2xl border-2 border-transparent hover:border-primary transition cursor-pointer text-center text-xs font-bold text-gray-500 uppercase text-gray-500 shadow-sm">Upload Ícone Portal</div>
                                    <input type="file" onChange={handlePortalIconUpload} className="hidden" accept="image/*" />
                                </label>
                            </div>
                        </div>
                        <div>
                            <label className="text-[10px] font-black text-gray-400 uppercase mb-2 block tracking-widest text-gray-400">Cor Principal</label>
                            <input type="color" value={settings.primaryColor} onChange={e => onUpdate({...settings, primaryColor: e.target.value})} className="w-full h-14 bg-transparent cursor-pointer rounded-2xl text-gray-800" />
                        </div>
                        <div className="pt-4 border-t border-gray-100 space-y-6 text-gray-800">
                            <h3 className="text-sm font-black uppercase text-gray-400 tracking-tighter">Visual do Login</h3>
                            <div>
                                <label className="text-[10px] font-black text-gray-400 uppercase mb-2 block tracking-widest text-gray-400">Título do Login</label>
                                <input value={settings.loginTitle || ''} onChange={e => onUpdate({...settings, loginTitle: e.target.value})} className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-primary transition text-gray-800 shadow-sm" />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-gray-400 uppercase mb-2 block tracking-widest text-gray-400">Ícone do Login (Upload)</label>
                                <div className="flex items-center gap-4 text-gray-800">
                                    {iconPreview || settings.loginIconUrl ? (
                                        <div className="w-16 h-16 rounded-2xl bg-gray-50 border-2 border-dashed border-gray-200 flex items-center justify-center overflow-hidden">
                                            <img src={iconPreview || settings.loginIconUrl} className="w-full h-full object-cover" alt="Login Icon" />
                                        </div>
                                    ) : (
                                        <div className="w-16 h-16 rounded-2xl bg-gray-50 border-2 border-dashed border-gray-200 flex items-center justify-center overflow-hidden">
                                            <Icon name="Image" className="text-gray-300" />
                                        </div>
                                    )}
                                    <label className="flex-1">
                                        <div className="p-4 bg-gray-50 rounded-2xl border-2 border-transparent hover:border-primary transition cursor-pointer text-center text-xs font-bold text-gray-500 uppercase text-gray-500 shadow-sm">Upload Ícone Login</div>
                                        <input type="file" onChange={handleIconUpload} className="hidden" accept="image/*" />
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-gray-400 uppercase mb-2 block tracking-widest text-gray-400">Link Banner de Fundo</label>
                                <input value={settings.loginBannerUrl || ''} onChange={e => onUpdate({...settings, loginBannerUrl: e.target.value})} className="w-full p-4 bg-gray-50 rounded-2xl font-medium text-xs border-2 border-transparent focus:border-primary transition text-gray-800 shadow-sm" placeholder="Cole o link da imagem" />
                            </div>
                        </div>
                        <button onClick={() => showToast("Ajustes salvos!")} className="w-full bg-primary text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg tracking-widest transition-transform active:scale-95 text-white">Salvar Configurações</button>
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---

        export default function App() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [view, setView] = useState('dashboard');
            const [toast, setToast] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            
            const [settings, setSettings] = useState({
                siteName: 'Portal Ministerial',
                primaryColor: '#3b82f6',
                logoUrl: '',
                loginBannerUrl: '',
                loginIconUrl: '',
                loginTitle: 'Mídia ADPerus',
                loginBgColor: '#3b82f6',
                modules: { events: true, attendance: true }
            });

            const [allUsers, setAllUsers] = useState([]);
            const [events, setEvents] = useState([]);
            const [attendance, setAttendance] = useState([]);
            const [departments, setDepartments] = useState([]);
            const [authError, setAuthError] = useState('');
            const [isAuthProcessing, setIsAuthProcessing] = useState(false);

            const showToast = (message, type = 'success') => { 
                setToast({ message, type }); 
                setTimeout(() => setToast(null), 3000); 
            };

            const notifications = useMemo(() => {
                if (!userProfile) return [];
                return events.filter(e => e.scaleStatus === 'ready' && attendance.some(a => a.eventId === e.id && a.userId === userProfile.uid && a.isEscalated));
            }, [events, attendance, userProfile]);

            // Auth Logic
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        setIsAuthReady(true);
                    } catch (err) { 
                        setIsAuthReady(true); 
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (!u) { setUserProfile(null); setLoading(false); }
                });
                return () => unsubscribe();
            }, []);

            // Data Logic
            useEffect(() => {
                if (!isAuthReady || !user) return;
                
                const unsubProfile = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), 
                    (snap) => { if (snap.exists()) setUserProfile(snap.data()); setLoading(false); }, 
                    () => { setLoading(false); }
                );
                
                const unsubSettings = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general'), 
                    (snap) => { if (snap.exists()) setSettings(snap.data()); }
                );
                
                const unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), 
                    snap => setAllUsers(snap.docs.map(d => ({ id: d.id, ...d.data() })))
                );
                
                const unsubEvents = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'events'), 
                    snap => setEvents(snap.docs.map(d => ({ id: d.id, ...d.data() })))
                );
                
                const unsubAtt = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), 
                    snap => setAttendance(snap.docs.map(d => ({ id: d.id, ...d.data() })))
                );
                
                const unsubDepts = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'departments'), 
                    snap => setDepartments(snap.docs.map(d => ({ id: d.id, ...d.data() })))
                );

                return () => { 
                    unsubProfile(); unsubSettings(); unsubUsers(); 
                    unsubEvents(); unsubAtt(); unsubDepts(); 
                };
            }, [isAuthReady, user]);

            const handleLogout = async () => { await signOut(auth); setView('dashboard'); };

            if (loading && user) return (
                <div className="h-screen flex items-center justify-center bg-gray-50">
                    <CustomStyles primaryColor={settings.primaryColor} />
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                </div>
            );

            if (!user || !userProfile) return (
                <AuthScreen 
                    settings={settings} 
                    onLogin={async (e) => {
                        e.preventDefault(); setAuthError(''); setIsAuthProcessing(true);
                        const { name, password } = e.target.elements;
                        try {
                            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
                            const uFound = snap.docs.map(d => d.data()).find(u => u.name?.trim().toLowerCase() === name.value.trim().toLowerCase());
                            if (!uFound) { setAuthError('Usuário não encontrado.'); setIsAuthProcessing(false); return; }
                            await signInWithEmailAndPassword(auth, uFound.email, password.value);
                        } catch (err) { setAuthError('Senha incorreta ou erro de acesso.'); } 
                        finally { setIsAuthProcessing(false); }
                    }} 
                    onRegister={async (e) => {
                        e.preventDefault(); setAuthError(''); setIsAuthProcessing(true);
                        const data = e.target.elements;
                        if (data.password.value.length < 6) { setAuthError('Mínimo 6 caracteres.'); setIsAuthProcessing(false); return; }
                        try {
                            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
                            if (snap.docs.some(d => d.data().name?.trim().toLowerCase() === data.name.value.trim().toLowerCase())) {
                                setAuthError('Nome de usuário já existe.'); setIsAuthProcessing(false); return;
                            }
                            const email = `${data.name.value.replace(/\s+/g, '').toLowerCase()}_${Date.now()}@portal.com`;
                            const res = await createUserWithEmailAndPassword(auth, email, data.password.value);
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', res.user.uid), {
                                uid: res.user.uid, name: data.name.value, email, 
                                phone: data.phone?.value || "", unidadeType: data.unidadeType.value,
                                regionalName: data.regionalName?.value || "", setorName: data.setorName?.value || "",
                                congregacaoName: data.congregacaoName?.value || "",
                                status: snap.empty ? 'active' : 'pending',
                                role: snap.empty ? 'master' : 'user', isAdmin: snap.empty,
                                isAvailable: true, joinDate: new Date().toISOString(), participatingDepts: []
                            });
                        } catch (err) { setAuthError('Erro ao criar conta.'); } 
                        finally { setIsAuthProcessing(false); }
                    }} 
                    onAdminLogin={async (e) => {
                        e.preventDefault(); setAuthError('');
                        if (e.target.adminPassword.value === '123') {
                            setIsAuthProcessing(true);
                            try {
                                let cur = auth.currentUser || (await signInAnonymously(auth)).user;
                                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', cur.uid), {
                                    uid: cur.uid, name: "Admin Master", email: "master@portal.com",
                                    role: 'master', status: 'active', isAdmin: true,
                                    isAvailable: true, joinDate: new Date().toISOString(), participatingDepts: []
                                });
                            } catch (err) { setAuthError('Erro.'); } finally { setIsAuthProcessing(false); }
                        } else { setAuthError('Senha mestre inválida.'); }
                    }} 
                    error={authError} isProcessing={isAuthProcessing} 
                />
            );

            if (userProfile.status === 'pending') return <PendingScreen onLogout={handleLogout} />;
            if (userProfile.status === 'blocked') return <BlockedScreen onLogout={handleLogout} />;

            return (
                <div className="flex h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
                    <CustomStyles primaryColor={settings.primaryColor} />
                    
                    {toast && (
                        <div className={`fixed bottom-8 right-8 z-[100] px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 animate-bounce ${toast.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                            <Icon name={toast.type === 'success' ? 'CheckCircle' : 'AlertCircle'} size={20} />
                            <span className="text-xs font-black uppercase tracking-widest text-white">{toast.message}</span>
                        </div>
                    )}

                    <aside className={`${isSidebarOpen ? 'w-64' : 'w-20'} bg-white border-r transition-all duration-300 flex flex-col z-30 no-print text-gray-800`}>
                        <div className="h-20 flex items-center px-6 border-b overflow-hidden gap-3 shrink-0 text-gray-800">
                            <div className="w-10 h-10 rounded-xl bg-primary flex items-center justify-center text-white font-black shrink-0 shadow-lg overflow-hidden text-sm uppercase">
                                {settings.logoUrl ? <img src={settings.logoUrl} className="w-full h-full object-cover" alt="Logo" /> : settings.siteName.charAt(0)}
                            </div>
                            {isSidebarOpen && <span className="font-bold text-lg truncate text-primary uppercase tracking-tighter">{settings.siteName}</span>}
                        </div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                            <NavItem active={view === 'dashboard'} iconName="LayoutDashboard" label="Dashboard" onClick={() => setView('dashboard')} open={isSidebarOpen} />
                            <NavItem active={view === 'agenda'} iconName="BookOpen" label="Agenda Ministerial" onClick={() => setView('agenda')} open={isSidebarOpen} />
                            <NavItem active={view === 'congressos'} iconName="Trophy" label="Congressos" onClick={() => setView('congressos')} open={isSidebarOpen} />
                            <NavItem active={view === 'my_depts'} iconName="Layers" label="Minhas Frentes" onClick={() => setView('my_depts')} open={isSidebarOpen} />
                            
                            {userProfile.isAdmin && (
                                <div className="pt-6 border-t mt-4 text-gray-800">
                                    <NavItem active={view === 'events_admin'} iconName="Calendar" label="Cronograma" onClick={() => setView('events_admin')} open={isSidebarOpen} />
                                    <NavItem active={view === 'users'} iconName="Users" label="Membros" onClick={() => setView('users')} open={isSidebarOpen} />
                                    <NavItem active={view === 'depts_admin'} iconName="Briefcase" label="Frentes" onClick={() => setView('depts_admin')} open={isSidebarOpen} />
                                    <NavItem active={view === 'reports'} iconName="BarChart3" label="Relatórios" onClick={() => setView('reports')} open={isSidebarOpen} />
                                    <NavItem active={view === 'settings'} iconName="Settings" label="Personalizar" onClick={() => setView('settings')} open={isSidebarOpen} />
                                </div>
                            )}
                        </nav>
                        <div className="p-4 border-t">
                            <button onClick={handleLogout} className="w-full flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 rounded-xl transition font-black text-[10px] uppercase text-red-500">
                                <Icon name="LogOut" size={20} /> {isSidebarOpen && "Sair"}
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col min-w-0 bg-gray-50/50">
                        <header className="h-20 bg-white border-b px-8 flex items-center justify-between shrink-0 no-print text-gray-800 shadow-sm">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-gray-100 rounded-lg transition-colors text-gray-800">
                                    <Icon name="Menu" size={20} />
                                </button>
                                {notifications.length > 0 && (
                                    <div className="flex items-center gap-2 bg-green-100 px-3 py-1.5 rounded-full animate-bounce shadow-sm">
                                        <Icon name="Bell" size={14} className="text-green-600" />
                                        <span className="text-[9px] font-black text-green-600 uppercase">Escala Pronta!</span>
                                    </div>
                                )}
                            </div>
                            <div className="flex items-center gap-3 text-right">
                                <div className="hidden sm:block text-gray-800">
                                    <p className="text-sm font-bold leading-none text-gray-800">{userProfile.name}</p>
                                    <p className="text-[10px] text-gray-400 uppercase font-black mt-1 tracking-widest">{userProfile.role}</p>
                                </div>
                                <div className="w-10 h-10 rounded-full bg-gray-100 border flex items-center justify-center text-gray-400 overflow-hidden">
                                    <Icon name="UserCircle" size={24} />
                                </div>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 sm:p-8">
                            {view === 'dashboard' && <DashboardView userProfile={userProfile} attendance={attendance} events={events} />}
                            {view === 'agenda' && <AgendaView events={events} attendance={attendance} userProfile={userProfile} departments={departments} category="Agenda Ministerial" showToast={showToast} />}
                            {view === 'congressos' && <AgendaView events={events} attendance={attendance} userProfile={userProfile} departments={departments} category="Congressos" showToast={showToast} />}
                            {view === 'my_depts' && <UserDepartments departments={departments} userProfile={userProfile} />}
                            
                            {userProfile.isAdmin && (
                                <>
                                    {view === 'events_admin' && <EventsAdmin events={events} attendance={attendance} departments={departments} allUsers={allUsers} showToast={showToast} />}
                                    {view === 'depts_admin' && <DepartmentsAdmin departments={departments} showToast={showToast} />}
                                    {view === 'users' && <MembersAdmin allUsers={allUsers} departments={departments} showToast={showToast} />}
                                    {view === 'reports' && <ReportsView attendance={attendance} allUsers={allUsers} departments={departments} />}
                                    {view === 'settings' && <SettingsAdminView settings={settings} onUpdate={s => setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general'), s)} showToast={showToast} />}
                                </>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
