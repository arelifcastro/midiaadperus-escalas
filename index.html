<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Ministerial</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        :root { --primary: #3b82f6; }
        .bg-primary { background-color: var(--primary); }
        .text-primary { color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        .ring-primary { --tw-ring-color: var(--primary); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <!-- Firebase SDKs (Versão Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Configuração Firebase ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gestao-ministerial-v1';

        // Inicialização Global
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Ícones Robustos (SVG Inline corrigido) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                dashboard: <path d="M3 3v18h18M7 16v-4m4 4V9m4 7V5m4 11v-2" />,
                users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2M9 7a4 4 0 0 1 0-8 4 4 0 0 1 0 8m14 14v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" />,
                calendar: (
                    <React.Fragment>
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <path d="M16 2v4M8 2v4M3 10h18" />
                    </React.Fragment>
                ),
                check: <polyline points="20 6 9 17 4 12" />,
                settings: (
                    <React.Fragment>
                        <circle cx="12" cy="12" r="3" />
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </React.Fragment>
                ),
                logout: (
                    <React.Fragment>
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </React.Fragment>
                ),
                plus: (
                    <React.Fragment>
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </React.Fragment>
                ),
                trash: (
                    <React.Fragment>
                        <polyline points="3 6 5 6 21 6" />
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    </React.Fragment>
                ),
                book: (
                    <React.Fragment>
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                        <path d="M4 19.5V4a2.5 2.5 0 0 1 2.5-2.5H20" />
                        <path d="M4 19.5H20" />
                    </React.Fragment>
                ),
                trophy: (
                    <React.Fragment>
                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                        <path d="M4 22h16" />
                        <path d="M10 14.66V17c0 .55.47.98.97 1.21C11.59 18.47 12 19 12 19.5V22" />
                        <path d="M10 14.66V10a8 8 0 0 1 16 0v4.66" />
                        <path d="M12 22v-2.5" />
                    </React.Fragment>
                ),
                chart: (
                    <React.Fragment>
                        <line x1="12" y1="20" x2="12" y2="10" />
                        <line x1="18" y1="20" x2="18" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="16" />
                    </React.Fragment>
                ),
                user: (
                    <React.Fragment>
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </React.Fragment>
                ),
                menu: (
                    <React.Fragment>
                        <line x1="3" y1="12" x2="21" y2="12" />
                        <line x1="3" y1="6" x2="21" y2="6" />
                        <line x1="3" y1="18" x2="21" y2="18" />
                    </React.Fragment>
                )
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- Componentes Atómicos ---
        function StatCard({ title, value, icon, colorClass }) {
            return (
                <div className="bg-white p-6 rounded-[2.5rem] border shadow-sm flex flex-col items-center justify-center text-center group hover:border-blue-400 transition-all">
                    <div className={`mb-3 p-4 bg-gray-50 rounded-[1.5rem] transition-colors group-hover:bg-blue-50 ${colorClass}`}>
                        {icon}
                    </div>
                    <div>
                        <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest leading-none mb-1.5">{title}</p>
                        <p className="text-3xl font-black tracking-tighter leading-none text-gray-800">{value}</p>
                    </div>
                </div>
            );
        }

        function NavItem({ active, icon, label, onClick, open }) {
            return (
                <button onClick={onClick} className={`w-full flex items-center gap-3 p-3 rounded-2xl transition-all duration-300 ${
                    active ? 'bg-blue-600 text-white shadow-xl scale-[1.02]' : 'text-gray-500 hover:bg-gray-100 hover:text-blue-600 active:scale-95'
                }`}>
                    <div className="shrink-0">{icon}</div>
                    {open && <span className="text-[10px] font-black uppercase tracking-widest">{label}</span>}
                </button>
            );
        }

        // --- App Principal ---
        function App() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [view, setView] = useState('dashboard');
            
            const [allUsers, setAllUsers] = useState([]);
            const [events, setEvents] = useState([]);
            const [attendance, setAttendance] = useState([]);
            const [departments, setDepartments] = useState([]);
            const [settings, setSettings] = useState({ siteName: 'Portal Ministerial', primaryColor: '#3b82f6' });
            
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [authError, setAuthError] = useState('');
            const [isAuthProcessing, setIsAuthProcessing] = useState(false);

            // REGRA 3: Autenticação antes de Consultas
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else if (!auth.currentUser) {
                            await auth.signInAnonymously();
                        }
                    } catch (err) {
                        console.error("Auth error", err);
                    }
                };

                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setIsAuthReady(true);
                });

                initAuth();
                return () => unsubscribe();
            }, []);

            // Data Fetching com Guardas de Permissão
            useEffect(() => {
                if (!isAuthReady || !user) return;

                const usersPath = `artifacts/${appId}/public/data/users`;
                const eventsPath = `artifacts/${appId}/public/data/events`;
                const attPath = `artifacts/${appId}/public/data/attendance`;
                const deptsPath = `artifacts/${appId}/public/data/departments`;
                const settingsPath = `artifacts/${appId}/public/data/settings`;

                // Listener de Perfil
                const unsubProfile = db.doc(`${usersPath}/${user.uid}`)
                    .onSnapshot((snap) => {
                        if (snap.exists) setUserProfile(snap.data());
                        setLoading(false);
                    }, (err) => console.warn("Acesso perfil negado ou em progresso."));

                // Outros Listeners
                const unsubUsers = db.collection(usersPath).onSnapshot(s => setAllUsers(s.docs.map(d => ({id: d.id, ...d.data()}))), e => {});
                const unsubEvents = db.collection(eventsPath).onSnapshot(s => setEvents(s.docs.map(d => ({id: d.id, ...d.data()}))), e => {});
                const unsubAtt = db.collection(attPath).onSnapshot(s => setAttendance(s.docs.map(d => ({id: d.id, ...d.data()}))), e => {});
                const unsubDepts = db.collection(deptsPath).onSnapshot(s => setDepartments(s.docs.map(d => ({id: d.id, ...d.data()}))), e => {});
                const unsubSettings = db.doc(`${settingsPath}/general`).onSnapshot(s => s.exists && setSettings(s.data()), e => {});

                return () => { unsubProfile(); unsubUsers(); unsubEvents(); unsubAtt(); unsubDepts(); unsubSettings(); };
            }, [isAuthReady, user]);

            const handleLogout = async () => {
                await auth.signOut();
                setUserProfile(null);
                await auth.signInAnonymously();
                setView('dashboard');
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError('');
                setIsAuthProcessing(true);
                const nameInput = e.target.name.value.trim().toLowerCase();
                const pass = e.target.password.value;
                const found = allUsers.find(u => u.name?.toLowerCase() === nameInput);
                if (found) {
                    try { await auth.signInWithEmailAndPassword(found.email, pass); }
                    catch (err) { setAuthError("Senha incorreta."); }
                } else { setAuthError("Voluntário não encontrado."); }
                setIsAuthProcessing(false);
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setAuthError('');
                setIsAuthProcessing(true);
                const { name, unidadeType, regionalName, setorName, congregacaoName, password } = e.target.elements;
                if (password.value.length < 6) {
                    setAuthError("Senha deve ter 6+ chars.");
                    setIsAuthProcessing(false);
                    return;
                }
                
                const email = `${name.value.replace(/\s+/g, '').toLowerCase()}_${Date.now()}@portal.com`;
                try {
                    const res = await auth.createUserWithEmailAndPassword(email, password.value);
                    const path = `artifacts/${appId}/public/data/users/${res.user.uid}`;
                    await db.doc(path).set({
                        uid: res.user.uid, name: name.value, email, 
                        unidadeType: unidadeType.value, regionalName: regionalName?.value || "",
                        setorName: setorName?.value || "", congregacaoName: congregacaoName?.value || "",
                        status: 'pending', role: 'user', isAdmin: false, isAvailable: true, joinDate: new Date().toISOString(),
                        participatingDepts: []
                    });
                } catch (err) { setAuthError("Erro no cadastro."); }
                setIsAuthProcessing(false);
            };

            const handleAdminLogin = async (e) => {
                e.preventDefault();
                if (e.target.adminPassword.value === '123') {
                    const path = `artifacts/${appId}/public/data/users/${user.uid}`;
                    await db.doc(path).set({
                        uid: user.uid, name: "Admin Master", email: "admin@portal.com", role: 'master', status: 'active', isAdmin: true, isAvailable: true,
                        unidadeType: 'Geral', regionalName: 'Sede', participatingDepts: []
                    });
                } else { setAuthError("Senha mestre inválida."); }
            };

            if (loading && user && userProfile) return (
                <div className="h-screen flex items-center justify-center bg-gray-50">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>
            );

            if (!user || !userProfile) {
                return (
                    <AuthScreen 
                        error={authError} 
                        isProcessing={isAuthProcessing}
                        onLogin={handleLogin}
                        onRegister={handleRegister}
                        onAdminLogin={handleAdminLogin}
                    />
                );
            }

            return (
                <div className="flex h-screen bg-gray-50 overflow-hidden text-sm">
                    <aside className={`${isSidebarOpen ? 'w-64' : 'w-20'} bg-white border-r transition-all duration-300 flex flex-col z-30 shadow-sm`}>
                        <div className="h-20 flex items-center px-6 border-b shrink-0">
                            <div className="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center text-white font-black">
                                {settings.siteName.charAt(0)}
                            </div>
                            {isSidebarOpen && <span className="ml-3 font-bold text-lg text-blue-600 uppercase tracking-tighter truncate">{settings.siteName}</span>}
                        </div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto scrollbar-hide">
                            <NavItem active={view === 'dashboard'} icon={<Icon name="dashboard"/>} label="Dashboard" onClick={() => setView('dashboard')} open={isSidebarOpen} />
                            <NavItem active={view === 'agenda'} icon={<Icon name="book"/>} label="Agenda Ministerial" onClick={() => setView('agenda')} open={isSidebarOpen} />
                            <NavItem active={view === 'congressos'} icon={<Icon name="trophy"/>} label="Congressos" onClick={() => setView('congressos')} open={isSidebarOpen} />
                            
                            {userProfile.isAdmin && (
                                <div className="pt-6 border-t mt-4">
                                    <NavItem active={view === 'events_admin'} icon={<Icon name="calendar"/>} label="Gestão Eventos" onClick={() => setView('events_admin')} open={isSidebarOpen} />
                                    <NavItem active={view === 'users'} icon={<Icon name="users"/>} label="Membros" onClick={() => setView('users')} open={isSidebarOpen} />
                                    <NavItem active={view === 'reports'} icon={<Icon name="chart"/>} label="Relatórios & BI" onClick={() => setView('reports')} open={isSidebarOpen} />
                                </div>
                            )}
                        </nav>
                        <div className="p-4 border-t">
                            <button onClick={handleLogout} className="w-full flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 rounded-xl font-black text-[10px] uppercase">
                                <Icon name="logout"/> {isSidebarOpen && "Sair"}
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col min-w-0">
                        <header className="h-20 bg-white border-b px-8 flex items-center justify-between shrink-0">
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="menu" /></button>
                            <div className="flex items-center gap-3 text-right">
                                <div className="hidden sm:block">
                                    <p className="text-sm font-bold text-gray-800">{userProfile.name}</p>
                                    <p className="text-[10px] text-gray-400 uppercase font-black leading-none">{userProfile.role}</p>
                                </div>
                                <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                                    <Icon name="user" size={24} className="text-gray-300" />
                                </div>
                            </div>
                        </header>
                        <div className="flex-1 overflow-y-auto p-8 scrollbar-hide">
                            {view === 'dashboard' && <DashboardView userProfile={userProfile} attendance={attendance} events={events} />}
                            {view === 'reports' && <ReportsView allUsers={allUsers} attendance={attendance} departments={departments} />}
                            {(view === 'agenda' || view === 'congressos') && (
                                <AgendaView events={events} attendance={attendance} userProfile={userProfile} departments={departments} category={view === 'agenda' ? "Agenda Ministerial" : "Congressos"} />
                            )}
                            {view === 'events_admin' && <EventsAdminView events={events} attendance={attendance} departments={departments} />}
                            {view === 'users' && <UsersAdminView allUsers={allUsers} departments={departments} />}
                        </div>
                    </main>
                </div>
            );
        }

        // --- SUB-VISTAS ---

        function DashboardView({ userProfile, attendance, events }) {
            const filtered = attendance.filter(a => a.userId === userProfile.uid);
            return (
                <div className="space-y-6 animate-in">
                    <h1 className="text-3xl font-black uppercase tracking-tighter text-gray-800">Painel Geral</h1>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="Disponível" value={filtered.filter(a => a.status === 'present').length} icon={<Icon name="checkSquare" size={24}/>} colorClass="text-green-500" />
                        <StatCard title="Indisponível" value={filtered.filter(a => a.status === 'absent').length} icon={<Icon name="trash" size={24}/>} colorClass="text-red-500" />
                        <StatCard title="Escalado" value={filtered.filter(a => a.isEscalated).length} icon={<Icon name="check" size={24}/>} colorClass="text-purple-500" />
                        <StatCard title="Eventos Ativos" value={events.length} icon={<Icon name="calendar" size={24}/>} colorClass="text-blue-500" />
                    </div>
                </div>
            );
        }

        function ReportsView({ allUsers, attendance, departments }) {
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());

            const filteredData = attendance.filter(a => {
                const d = new Date(a.timestamp);
                return d.getMonth() === filterMonth && d.getFullYear() === filterYear;
            });

            return (
                <div className="space-y-8 animate-in pb-12">
                    <div className="flex justify-between items-center border-b pb-6">
                        <h2 className="text-3xl font-black uppercase tracking-tighter text-gray-800">BI Ministerial</h2>
                        <div className="flex gap-2 bg-white p-2 rounded-2xl border shadow-sm">
                            <select value={filterMonth} onChange={e => setFilterMonth(Number(e.target.value))} className="bg-transparent text-xs font-black uppercase outline-none px-2 cursor-pointer">
                                {["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"].map((m, i) => <option key={i} value={i}>{m}</option>)}
                            </select>
                            <select value={filterYear} onChange={e => setFilterYear(Number(e.target.value))} className="bg-transparent text-xs font-black uppercase outline-none px-2 cursor-pointer">
                                {[2024, 2025, 2026].map(y => <option key={y} value={y}>{y}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
                        <div className="bg-white p-6 rounded-[2.5rem] border shadow-sm">
                            <p className="text-[10px] font-black text-gray-400 uppercase mb-2">Presença Geral</p>
                            <p className="text-4xl font-black text-blue-600">{filteredData.length > 0 ? ((filteredData.filter(a => a.status === 'present').length / filteredData.length) * 100).toFixed(0) : 0}%</p>
                        </div>
                    </div>
                </div>
            );
        }

        function AgendaView({ events, attendance, userProfile, departments, category }) {
            const filtered = events.filter(e => e.category === category || (!e.category && category === "Agenda Ministerial"));
            
            const handleRespond = async (ev, status, deptId = null) => {
                const dept = departments.find(d => d.id === deptId);
                const attId = `${ev.id}_${userProfile.uid}`;
                const path = `artifacts/${appId}/public/data/attendance/${attId}`;
                await db.doc(path).set({
                    id: attId, eventId: ev.id, eventName: ev.name, eventDate: ev.date, eventCategory: category,
                    userId: userProfile.uid, userName: userProfile.name, servingDept: dept ? dept.name : 'N/A',
                    status, isEscalated: false, timestamp: new Date().toISOString()
                });
            };

            return (
                <div className="space-y-6 animate-in">
                    <h1 className="text-3xl font-black uppercase tracking-tighter text-gray-800">{category}</h1>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filtered.map(ev => {
                            const myAtt = attendance.find(a => a.eventId === ev.id && a.userId === userProfile.uid);
                            const isReady = ev.scaleStatus === 'ready';
                            return (
                                <div key={ev.id} className={`bg-white p-6 rounded-[2.5rem] border shadow-sm flex flex-col group ${isReady && myAtt?.isEscalated ? 'ring-2 ring-green-500' : ''}`}>
                                    <div className="flex items-center gap-4 mb-4">
                                        <div className="w-12 h-12 rounded-2xl bg-blue-600 text-white flex items-center justify-center font-black text-xl">
                                            {new Date(ev.date).getUTCDate()}
                                        </div>
                                        <div className="flex-1">
                                            <p className="font-black uppercase text-sm leading-none text-gray-700">{ev.name}</p>
                                            <p className="text-[10px] text-gray-400 font-bold mt-1 uppercase tracking-widest">{ev.time} • {ev.period}</p>
                                        </div>
                                    </div>
                                    <div className="mt-auto pt-4 border-t">
                                        {myAtt ? (
                                            <div className={`p-4 rounded-2xl text-center font-black text-[10px] uppercase ${myAtt.status === 'present' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}`}>
                                                {myAtt.status === 'present' ? `Vou em: ${myAtt.servingDept}` : 'Indisponível'}
                                            </div>
                                        ) : isReady ? (
                                            <div className="bg-gray-100 p-4 rounded-2xl text-center text-[10px] font-black uppercase text-gray-400">Escala Fechada</div>
                                        ) : (
                                            <div className="flex flex-col gap-2">
                                                <select onChange={(e) => handleRespond(ev, 'present', e.target.value)} className="w-full p-3 bg-blue-600 text-white rounded-xl font-black text-[10px] uppercase outline-none cursor-pointer">
                                                    <option value="">Informar Disponibilidade</option>
                                                    {departments.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                                                </select>
                                                <button onClick={() => handleRespond(ev, 'absent')} className="w-full p-3 border-2 border-red-100 text-red-500 rounded-xl font-black text-[10px] uppercase hover:bg-red-50 transition-colors">Não Posso Ir</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function EventsAdminView({ events, attendance, departments }) {
            const [showAdd, setShowAdd] = useState(false);
            const handleCreate = async (e) => {
                e.preventDefault();
                const data = new FormData(e.target);
                const path = `artifacts/${appId}/public/data/events`;
                await db.collection(path).add({
                    name: data.get('name'), date: data.get('date'), time: data.get('time'), category: data.get('category'),
                    period: data.get('period'), location: data.get('location'), scaleStatus: 'draft'
                });
                setShowAdd(false);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-black uppercase tracking-tighter text-gray-800">Cronograma</h2>
                        <button onClick={() => setShowAdd(true)} className="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold shadow-md hover:bg-blue-700 transition-colors">Novo Evento</button>
                    </div>
                    {showAdd && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <form onSubmit={handleCreate} className="bg-white p-8 rounded-[3rem] w-full max-w-md space-y-4 shadow-2xl">
                                <h2 className="text-xl font-black uppercase text-gray-700">Novo Registro</h2>
                                <select name="category" className="w-full p-4 bg-gray-50 rounded-xl border focus:border-blue-600 outline-none" required>
                                    <option value="Agenda Ministerial">Agenda Ministerial</option>
                                    <option value="Congressos">Congressos</option>
                                </select>
                                <input name="name" placeholder="Nome do Evento" className="w-full p-4 bg-gray-50 rounded-xl border focus:border-blue-600 outline-none" required />
                                <input name="date" type="date" className="w-full p-4 bg-gray-50 rounded-xl border focus:border-blue-600 outline-none" required />
                                <div className="flex gap-4">
                                    <button type="button" onClick={() => setShowAdd(false)} className="flex-1 p-4 text-gray-400 font-black uppercase text-xs">Cancelar</button>
                                    <button type="submit" className="flex-1 p-4 bg-blue-600 text-white font-black rounded-xl uppercase text-xs">Salvar</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        function UsersAdminView({ allUsers, departments }) {
            const toggleStatus = async (u) => {
                const path = `artifacts/${appId}/public/data/users/${u.uid}`;
                await db.doc(path).update({
                    status: u.status === 'active' ? 'blocked' : 'active'
                });
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-black uppercase tracking-tighter text-gray-800">Gestão de Equipe</h2>
                    <div className="bg-white rounded-[2.5rem] border overflow-hidden shadow-sm">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 text-[10px] font-black uppercase tracking-widest border-b">
                                <tr>
                                    <th className="px-6 py-4 text-gray-500">Membro</th>
                                    <th className="px-6 py-4 text-gray-500">Igreja / Unidade</th>
                                    <th className="px-6 py-4 text-gray-500">Estado</th>
                                    <th className="px-6 py-4 text-right text-gray-500">Ação</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {allUsers.map(u => (
                                    <tr key={u.uid} className="hover:bg-gray-50 transition-colors text-sm">
                                        <td className="px-6 py-4 font-bold text-gray-700">{u.name}</td>
                                        <td className="px-6 py-4 text-[10px] uppercase font-bold text-gray-400">
                                            {u.unidadeType}: {u.congregacaoName || u.setorName || u.regionalName}
                                        </td>
                                        <td className="px-6 py-4">
                                            <span className={`px-2 py-1 rounded-lg text-[9px] font-black uppercase ${u.status === 'active' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{u.status}</span>
                                        </td>
                                        <td className="px-6 py-4 text-right">
                                            <button onClick={() => toggleStatus(u)} className="text-blue-600 font-bold text-[10px] uppercase hover:underline">Alternar</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function AuthScreen({ onLogin, onRegister, onAdminLogin, error, isProcessing }) {
            const [mode, setMode] = useState('login');
            const [selectedUnidade, setSelectedUnidade] = useState("");

            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans text-gray-800">
                    <div className="max-w-4xl w-full bg-white rounded-[4rem] shadow-2xl overflow-hidden flex flex-col md:flex-row border border-gray-100">
                        <div className="md:w-1/2 bg-blue-600 p-12 text-white flex flex-col justify-center text-center relative overflow-hidden">
                            <h1 className="text-4xl font-black mb-4 uppercase leading-none tracking-tighter">Portal Ministerial</h1>
                            <p className="text-[10px] font-bold uppercase tracking-[0.4em] opacity-60">Gestão de Equipes</p>
                        </div>
                        <div className="md:w-1/2 p-12 overflow-y-auto max-h-[90vh] scrollbar-hide text-sm">
                            <div className="flex gap-2 mb-8 bg-gray-100 p-1.5 rounded-3xl">
                                <button onClick={() => setMode('login')} className={`flex-1 py-3 text-[10px] font-black uppercase rounded-2xl transition-all ${mode === 'login' ? 'bg-white shadow text-blue-600' : 'text-gray-400'}`}>Acesso</button>
                                <button onClick={() => setMode('register')} className={`flex-1 py-3 text-[10px] font-black uppercase rounded-2xl transition-all ${mode === 'register' ? 'bg-white shadow text-blue-600' : 'text-gray-400'}`}>Cadastro</button>
                                <button onClick={() => setMode('admin')} className={`flex-1 py-3 text-[10px] font-black uppercase rounded-2xl transition-all ${mode === 'admin' ? 'bg-white shadow text-purple-600' : 'text-gray-400'}`}>Admin</button>
                            </div>
                            
                            <form onSubmit={(e) => {
                                if (mode === 'login') onLogin(e);
                                else if (mode === 'register') onRegister(e);
                                else onAdminLogin(e);
                            }} className="space-y-4">
                                {mode === 'login' && (
                                    <React.Fragment>
                                        <input name="name" placeholder="Nome de Utilizador" required className="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm border focus:border-blue-600 transition-all shadow-sm" />
                                        <input name="password" type="password" placeholder="Senha" required className="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm border focus:border-blue-600 transition-all shadow-sm" />
                                    </React.Fragment>
                                )}
                                {mode === 'register' && (
                                    <div className="space-y-3 animate-in">
                                        <input name="name" placeholder="Nome Completo" required className="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm shadow-sm" />
                                        <select name="unidadeType" defaultValue="" required onChange={(e) => setSelectedUnidade(e.target.value)} className="w-full p-4 bg-gray-50 rounded-2xl outline-none font-black text-[10px] border uppercase tracking-widest cursor-pointer shadow-sm">
                                            <option value="" disabled>Selecione sua Igreja</option>
                                            <option value="Regional">Regional</option>
                                            <option value="Setor">Setor</option>
                                            <option value="Congregação">Congregação</option>
                                        </select>
                                        {selectedUnidade && <input name="regionalName" placeholder="Nome da Regional" required className="w-full p-4 bg-white border-2 border-blue-200 rounded-2xl outline-none font-bold text-sm animate-in" />}
                                        {(selectedUnidade === "Setor" || selectedUnidade === "Congregação") && <input name="setorName" placeholder="Nome do Setor" required className="w-full p-4 bg-white border-2 border-blue-200 rounded-2xl outline-none font-bold text-sm animate-in" />}
                                        {selectedUnidade === "Congregação" && <input name="congregacaoName" placeholder="Nome da Congregação" required className="w-full p-4 bg-white border-2 border-blue-200 rounded-2xl outline-none font-bold text-sm animate-in" />}
                                        <input name="password" type="password" placeholder="Senha (min. 6 chars)" required className="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm shadow-sm" />
                                    </div>
                                )}
                                {mode === 'admin' && <input name="adminPassword" type="password" placeholder="Senha Mestre Padrão" required className="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm border border-purple-200 shadow-sm" />}
                                {error && <div className="p-4 bg-red-50 text-red-500 rounded-2xl text-[10px] font-black uppercase text-center border border-red-100">{error}</div>}
                                <button type="submit" disabled={isProcessing} className={`w-full ${mode === 'admin' ? 'bg-purple-600' : 'bg-blue-600'} text-white py-5 rounded-[1.5rem] font-black shadow-xl uppercase tracking-widest text-[11px] transition-all active:scale-95`}>
                                    {isProcessing ? "A processar..." : "Confirmar"}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
