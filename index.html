<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mídia ADPerus - Escalas</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://unpkg.com/lucide-react@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            LayoutDashboard, Users, Calendar, CheckCircle, Settings, LogOut, Menu, X, Plus, Trash2, 
            UserCheck, UserMinus, ShieldAlert, Clock, ChevronRight, Bell, Layout, User, Crown, 
            Lock, Zap, BookOpen, ClipboardCheck, Search, Filter, Info, Mail, Phone, Building, 
            Image: ImageIcon, ToggleRight, ToggleLeft, Edit2, FileText, BarChart3, XCircle, 
            Briefcase, Layers, Palette, ChevronDown, Star, Check, Upload, RefreshCw, AlertCircle, 
            UserCircle, ClipboardList, Megaphone, CheckSquare, Square, HelpCircle, Trophy, 
            PieChart, SearchCode, MapPin, Church, Printer 
        } = LucideReact;

        // --- Firebase Mocks/Setup para Script ---
        // Nota: No ambiente de script, importamos via módulos ou globais específicos.
        // Como você forneceu a config, vamos inicializar.
        const firebaseConfig = {
            apiKey: "AIzaSyChhzYn6FhzGb7D5mggYeZFI9eW2mIJgro",
            authDomain: "midia-adperus-escalas.firebaseapp.com",
            projectId: "midia-adperus-escalas",
            storageBucket: "midia-adperus-escalas.appspot.com",
            messagingSenderId: "425939380478",
            appId: "1:425939380478:web:81ffd64a27468cb43a5daf",
            measurementId: "G-SH421MT1FC"
        };

        // Importando Firebase via CDN compatível
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, deleteDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "midia-adperus-escalas";

        // --- Estilos Globais ---
        const CustomStyles = ({ primaryColor }) => (
            <style>{`
                :root { --primary: ${primaryColor || '#3b82f6'}; }
                .bg-primary { background-color: var(--primary); }
                .text-primary { color: var(--primary); }
                .border-primary { border-color: var(--primary); }
                .ring-primary { --tw-ring-color: var(--primary); }
                .hover-bg-primary:hover { background-color: var(--primary); opacity: 0.9; }
                
                @media print {
                    .no-print { display: none !important; }
                    aside, header, button, .modal-overlay { display: none !important; }
                    main { margin: 0 !important; padding: 0 !important; width: 100% !important; overflow: visible !important; }
                    .print-container { display: block !important; padding: 20px !important; }
                    .card-print { border: 1px solid #eee !important; break-inside: avoid; margin-bottom: 15px; }
                    .bg-gray-50 { background-color: white !important; }
                    .text-primary { color: black !important; border-bottom: 2px solid var(--primary); }
                }
            `}</style>
        );

        // --- COMPONENTES AUXILIARES ---
        function StatCard({ title, value, icon }) {
            return (
                <div className="bg-white p-6 rounded-[2rem] border shadow-sm flex items-center gap-4 hover:translate-y-[-2px] transition-transform group card-print text-gray-800">
                    <div className="p-4 bg-gray-50 rounded-2xl transition-colors group-hover:bg-primary/5 text-primary">
                        {icon}
                    </div>
                    <div>
                        <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest leading-none mb-1">{title}</p>
                        <p className="text-2xl font-black tracking-tighter leading-none">{value}</p>
                    </div>
                </div>
            );
        }

        function NavItem({ active, icon, label, onClick, open }) {
            return (
                <button onClick={onClick} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all duration-200 ${
                    active ? 'bg-primary text-white shadow-lg shadow-blue-100' : 'text-gray-500 hover:bg-gray-100 hover:text-primary'
                }`}>
                    <div className="shrink-0">{React.cloneElement(icon, { size: 20, strokeWidth: active ? 3 : 2 })}</div>
                    {open && <span className="text-[10px] font-black uppercase tracking-tight">{label}</span>}
                </button>
            );
        }

        function StatItem({ title, value, icon, color }) {
            return (
                <div className="bg-white p-6 rounded-[2.5rem] border shadow-sm flex flex-col items-center justify-center text-center card-print text-gray-800">
                    <div className={`mb-3 ${color}`}>{React.cloneElement(icon, { size: 32 })}</div>
                    <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest leading-none mb-1">{title}</p>
                    <p className={`text-4xl font-black leading-none tracking-tighter ${color}`}>{value}</p>
                </div>
            );
        }

        // --- TELAS DE ACESSO ---
        function PendingScreen({ onLogout }) {
            return (
                <div className="h-screen bg-gray-50 flex items-center justify-center p-6 text-center text-gray-800">
                    <div className="max-w-sm bg-white p-12 rounded-[3rem] shadow-xl border border-gray-100 animate-in zoom-in">
                        <Clock className="text-yellow-500 animate-pulse mx-auto mb-4" size={60} />
                        <h1 className="text-3xl font-black mb-2 uppercase tracking-tighter leading-none">Aguardando</h1>
                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-8">Cadastro em análise. Fale com um administrador.</p>
                        <button onClick={onLogout} className="w-full py-4 rounded-2xl border-2 border-gray-100 font-black text-[10px] text-gray-400 hover:text-red-500 uppercase tracking-widest transition-all">Sair</button>
                    </div>
                </div>
            );
        }

        function BlockedScreen({ onLogout }) {
            return (
                <div className="h-screen bg-red-50 flex items-center justify-center p-6 text-center text-gray-800">
                    <div className="max-w-sm bg-white p-12 rounded-[3rem] shadow-xl border-t-8 border-red-500 animate-in zoom-in">
                        <ShieldAlert className="text-red-500 mx-auto mb-4" size={60} />
                        <h1 className="text-3xl font-black text-red-600 mb-2 uppercase tracking-tighter leading-none">Suspenso</h1>
                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-8">Acesso bloqueado por segurança.</p>
                        <button onClick={onLogout} className="w-full bg-red-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-[11px] transition hover:shadow-lg shadow-red-100">Sair</button>
                    </div>
                </div>
            );
        }

        function AuthScreen({ onLogin, onRegister, onAdminLogin, error, isProcessing, settings }) {
            const [mode, setMode] = useState('login');
            const [selectedUnidade, setSelectedUnidade] = useState("");

            const bannerBg = settings.loginBannerUrl 
                ? { backgroundImage: `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url(${settings.loginBannerUrl})`, backgroundSize: 'cover', backgroundPosition: 'center' }
                : { backgroundColor: settings.loginBgColor || settings.primaryColor };

            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans text-gray-800">
                    <div className="max-w-4xl w-full bg-white rounded-[3rem] shadow-2xl overflow-hidden flex flex-col md:flex-row border border-gray-100">
                        <div className="md:w-1/2 p-12 text-white flex flex-col justify-center relative overflow-hidden text-center transition-all duration-700" style={bannerBg}>
                            {!settings.loginBannerUrl && <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-32 -mt-32"></div>}
                            <div className="relative z-10">
                                <div className="w-24 h-24 mx-auto mb-6 bg-white/10 rounded-full flex items-center justify-center overflow-hidden border-2 border-white/20">
                                    {settings.loginIconUrl ? (
                                        <img src={settings.loginIconUrl} className="w-full h-full object-cover" alt="Icon" />
                                    ) : (
                                        <Crown size={48} className="opacity-80 text-white" />
                                    )}
                                </div>
                                <h1 className="text-4xl font-black mb-2 uppercase leading-none tracking-tighter text-white drop-shadow-lg">
                                    {settings.loginTitle || "Mídia ADPerus"}
                                </h1>
                            </div>
                        </div>
                        <div className="md:w-1/2 p-12 overflow-y-auto max-h-[90vh]">
                            <div className="flex gap-2 mb-8 bg-gray-100 p-1 rounded-2xl">
                                <button onClick={() => setMode('login')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-xl transition ${mode === 'login' ? 'bg-white shadow text-primary' : 'text-gray-400'}`}>Entrar</button>
                                <button onClick={() => setMode('register')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-xl transition ${mode === 'register' ? 'bg-white shadow text-primary' : 'text-gray-400'}`}>Cadastrar</button>
                                <button onClick={() => setMode('admin')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-xl transition ${mode === 'admin' ? 'bg-white shadow text-purple-600' : 'text-gray-400'}`}>Admin</button>
                            </div>
                            
                            <form onSubmit={mode === 'admin' ? onAdminLogin : mode === 'login' ? onLogin : onRegister} className="space-y-4">
                                {mode === 'login' && (
                                    <div className="space-y-4 text-gray-800">
                                        <div className="relative"><UserCircle className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={18} /><input name="name" placeholder="Usuário" required className="w-full pl-12 pr-4 py-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-primary/20 transition text-gray-800" /></div>
                                        <div className="relative"><Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={18} /><input name="password" type="password" placeholder="Senha" required className="w-full pl-12 pr-4 py-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-primary/20 transition text-gray-800" /></div>
                                    </div>
                                )}
                                
                                {mode === 'register' && (
                                    <div className="space-y-3 text-gray-800">
                                        <div className="relative"><User className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={18} /><input name="name" placeholder="Nome Completo" required className="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                        <div className="relative"><Phone className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={18} /><input name="phone" placeholder="WhatsApp" required className="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                        <div className="relative"><MapPin className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={18} /><select name="unidadeType" defaultValue="" required onChange={(e) => setSelectedUnidade(e.target.value)} className="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-xl outline-none font-bold text-xs"><option value="" disabled>Igreja: Regional, Setor ou Congregação?</option><option value="Regional">Regional</option><option value="Setor">Setor</option><option value="Congregação">Congregação</option></select></div>

                                        {(selectedUnidade === "Regional" || selectedUnidade === "Setor" || selectedUnidade === "Congregação") && (
                                            <div className="relative"><Church className="absolute left-4 top-1/2 -translate-y-1/2 text-primary" size={18} /><input name="regionalName" placeholder="Nome da Regional" required className="w-full pl-12 pr-4 py-3 bg-white border-2 border-primary/20 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                        )}
                                        {(selectedUnidade === "Setor" || selectedUnidade === "Congregação") && (
                                            <div className="relative"><Layers className="absolute left-4 top-1/2 -translate-y-1/2 text-primary" size={18} /><input name="setorName" placeholder="Nome do Setor" required className="w-full pl-12 pr-4 py-3 bg-white border-2 border-primary/20 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                        )}
                                        {selectedUnidade === "Congregação" && (
                                            <div className="relative"><Building className="absolute left-4 top-1/2 -translate-y-1/2 text-primary" size={18} /><input name="congregacaoName" placeholder="Nome da Congregação" required className="w-full pl-12 pr-4 py-3 bg-white border-2 border-primary/20 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                        )}
                                        <div className="relative"><Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={18} /><input name="password" type="password" placeholder="Criar Senha (mín. 6)" required className="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-xl outline-none font-bold text-sm text-gray-800" /></div>
                                    </div>
                                )}
                                
                                {mode === 'admin' && (
                                    <div className="relative text-gray-800"><ShieldAlert className="absolute left-4 top-1/2 -translate-y-1/2 text-purple-400" size={18} /><input name="adminPassword" type="password" placeholder="Senha Master" required className="w-full pl-12 pr-4 py-4 bg-gray-50 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-purple-200 transition text-gray-800" /></div>
                                )}
                                
                                {error && <div className="p-4 bg-red-50 text-red-500 rounded-2xl text-[10px] font-black uppercase flex items-center gap-2"><AlertCircle size={14}/> {error}</div>}
                                
                                <button type="submit" disabled={isProcessing} className={`w-full ${mode === 'admin' ? 'bg-purple-600' : 'bg-primary'} text-white py-5 rounded-[1.5rem] font-black shadow-xl uppercase tracking-widest text-[11px] transition-transform active:scale-95`}>
                                    {isProcessing ? "Aguarde..." : "Entrar"}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // --- VISÕES DE CONTEÚDO ---
        function DashboardView({ userProfile, attendance, events }) {
            const [month, setMonth] = useState(new Date().getMonth());
            const [year, setYear] = useState(new Date().getFullYear());

            const filteredAtt = useMemo(() => attendance.filter(a => {
                const d = new Date(a.timestamp);
                return a.userId === userProfile.uid && d.getMonth() === Number(month) && d.getFullYear() === Number(year);
            }), [attendance, userProfile.uid, month, year]);

            const stats = {
                available: filteredAtt.filter(a => a.status === 'present').length,
                unavailable: filteredAtt.filter(a => a.status === 'absent').length,
                escalated: filteredAtt.filter(a => a.isEscalated).length,
                pending: events.filter(e => new Date(e.date) > new Date()).length
            };

            return (
                <div className="space-y-6 text-gray-800">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 no-print">
                        <h1 className="text-3xl font-black tracking-tighter uppercase leading-none">Visão Geral</h1>
                        <div className="flex gap-2 bg-white p-2 rounded-2xl border shadow-sm">
                            <select value={month} onChange={e => setMonth(e.target.value)} className="bg-transparent text-xs font-black uppercase outline-none px-2 cursor-pointer text-gray-800">{["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"].map((m, i) => <option key={i} value={i}>{m}</option>)}</select>
                            <select value={year} onChange={e => setYear(e.target.value)} className="bg-transparent text-xs font-black uppercase outline-none px-2 cursor-pointer text-gray-800">{[2024, 2025, 2026].map(y => <option key={y} value={y}>{y}</option>)}</select>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="Disponível" value={stats.available} icon={<CheckCircle className="text-green-500" />} />
                        <StatCard title="Indisponível" value={stats.unavailable} icon={<XCircle className="text-red-500" />} />
                        <StatCard title="Escalado" value={stats.escalated} icon={<ClipboardCheck className="text-purple-500" />} />
                        <StatCard title="Eventos Futuros" value={stats.pending} icon={<Clock className="text-blue-500" />} />
                    </div>
                    <div className="bg-white p-8 rounded-[2.5rem] border shadow-sm">
                        <h2 className="text-xl font-black uppercase tracking-tighter mb-6 flex items-center gap-2"><FileText className="text-primary" /> Histórico Ministerial</h2>
                        <div className="divide-y divide-gray-50">{filteredAtt.map(a => (<div key={a.id} className="py-4 flex justify-between items-center text-gray-800"><div><p className="font-bold uppercase text-xs">{a.eventName}</p><p className="text-[10px] text-gray-400 font-black uppercase tracking-tight">{a.servingDept} • {new Date(a.timestamp).toLocaleDateString()}</p></div><span className={`px-3 py-1 rounded-lg text-[9px] font-black uppercase ${a.status === 'present' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{a.status === 'present' ? "Disponível" : "Ausente"}</span></div>))}</div>
                    </div>
                </div>
            );
        }

        function AgendaView({ events, attendance, userProfile, departments, category, showToast }) {
            const [activeTab, setActiveTab] = useState('semanal');
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [expandedEvent, setExpandedEvent] = useState(null);

            const filteredEvents = useMemo(() => events.filter(ev => {
                const d = new Date(ev.date);
                if (d.getUTCMonth() !== Number(filterMonth) || d.getUTCFullYear() !== Number(filterYear)) return false;
                if (ev.category !== category && !(ev.category === undefined && category === "Agenda Ministerial")) return false;
                if (activeTab === 'sábados') return d.getUTCDay() === 6;
                if (activeTab === 'domingos') return d.getUTCDay() === 0;
                return d.getUTCDay() !== 0 && d.getUTCDay() !== 6;
            }).sort((a,b) => new Date(a.date) - new Date(b.date)), [events, activeTab, filterMonth, filterYear, category]);

            const respond = async (event, status, deptName = 'INDISPONÍVEL') => {
                const attId = `${event.id}_${userProfile.uid}`;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', attId), {
                    id: attId, eventId: event.id, eventName: event.name, eventDate: event.date, eventCategory: category,
                    userId: userProfile.uid, userName: userProfile.name, servingDept: deptName,
                    status: status, isEscalated: false, timestamp: new Date().toISOString()
                });
                setExpandedEvent(null);
                showToast("Confirmado!");
            };

            return (
                <div className="space-y-6 text-gray-800">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 no-print">
                        <h1 className="text-3xl font-black tracking-tighter uppercase leading-none">{category}</h1>
                        <div className="flex gap-2 bg-white p-2 rounded-2xl border shadow-sm">
                            <select value={filterMonth} onChange={e => setFilterMonth(e.target.value)} className="bg-transparent text-xs font-black uppercase px-2 outline-none cursor-pointer text-gray-800">{["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"].map((m, i) => <option key={i} value={i}>{m}</option>)}</select>
                        </div>
                    </div>
                    <div className="flex gap-2 bg-white p-1 rounded-2xl border shadow-sm w-fit no-print">
                        {['semanal', 'sábados', 'domingos'].map(t => <button key={t} onClick={() => setActiveTab(t)} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${activeTab === t ? 'bg-primary text-white shadow-lg' : 'text-gray-400'}`}>{t}</button>)}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filteredEvents.map(ev => {
                            const myAtt = attendance.find(a => a.eventId === ev.id && a.userId === userProfile.uid);
                            const isReady = ev.scaleStatus === 'ready';
                            return (
                                <div key={ev.id} className="bg-white rounded-[2.5rem] border p-6 shadow-sm hover:border-primary transition-all flex flex-col card-print text-gray-800">
                                    <div className="flex items-center gap-4 mb-4">
                                        <div className={`flex flex-col items-center justify-center text-white rounded-2xl w-16 h-16 shrink-0 shadow-lg ${isReady ? 'bg-gray-800' : 'bg-primary'}`}>
                                            <span className="text-2xl font-black leading-none">{new Date(ev.date).getUTCDate()}</span>
                                        </div>
                                        <div>
                                            <div className="flex items-center gap-1 text-primary font-black text-xl leading-none">
                                                <Clock size={18} /> {ev.time}
                                            </div>
                                            {isReady && <span className="text-[10px] font-black text-green-500 uppercase">Escala Pronta</span>}
                                        </div>
                                    </div>
                                    <h3 className="text-lg font-black uppercase mb-2">{ev.name}</h3>
                                    <div className="no-print mt-auto">
                                        {isReady ? (
                                            myAtt?.isEscalated ? <div className="bg-green-50 p-4 rounded-2xl text-center border-2 border-green-100 text-green-700 font-black uppercase text-xs shadow-sm">Escalado: {myAtt.servingDept}</div> : <div className="bg-gray-50 p-4 rounded-2xl text-center text-gray-400 font-black uppercase text-[10px]">Não escalado</div>
                                        ) : expandedEvent === ev.id ? (
                                            <div className="space-y-2">
                                                {departments.filter(d => userProfile.participatingDepts?.includes(d.id) || userProfile.role === 'master').map(d => (
                                                    <button key={d.id} onClick={() => respond(ev, 'present', d.name)} className="w-full p-2 border-2 rounded-xl text-[10px] font-black uppercase text-primary hover:bg-primary/5 transition-colors" style={{ borderColor: d.color, color: d.color }}>{d.name}</button>
                                                ))}
                                                <button onClick={() => respond(ev, 'absent')} className="w-full p-3 bg-red-50 text-red-600 rounded-xl text-[10px] font-black uppercase">Ausente</button>
                                                <button onClick={() => setExpandedEvent(null)} className="w-full text-xs font-black text-gray-400 mt-2">Cancelar</button>
                                            </div>
                                        ) : (
                                            <button onClick={() => setExpandedEvent(ev.id)} className="w-full py-4 bg-primary text-white rounded-2xl font-black text-[11px] uppercase shadow-lg shadow-blue-100">{myAtt ? "Alterar Resposta" : "Responder"}</button>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // --- RESTO DOS COMPONENTES (MEMBROS, DEPARTAMENTOS, RELATORIOS, ETC) ---
        // Seguindo a mesma lógica do seu código original...

        function UserDepartments({ departments, userProfile }) {
            const myDepts = useMemo(() => departments.filter(d => userProfile.participatingDepts?.includes(d.id)), [departments, userProfile.participatingDepts]);
            return (
                <div className="space-y-6 text-gray-800">
                    <h1 className="text-3xl font-black tracking-tighter uppercase leading-none">Minhas Frentes</h1>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {myDepts.map(d => (
                            <div key={d.id} className="bg-white p-8 rounded-[2.5rem] border-l-8 shadow-sm relative overflow-hidden group" style={{ borderLeftColor: d.color }}>
                                <div className="flex justify-between items-start mb-6">
                                    <div className="p-3 rounded-2xl overflow-hidden shadow-sm" style={{ backgroundColor: `${d.color}20`, color: d.color }}>
                                        {d.icon && typeof d.icon === 'string' && d.icon.startsWith('data:image') ? <img src={d.icon} className="w-8 h-8 object-cover" alt="Icon" /> : <Briefcase size={24} />}
                                    </div>
                                    <span className="text-[10px] font-black text-green-500 uppercase tracking-widest">Ativo</span>
                                </div>
                                <h3 className="text-xl font-black uppercase tracking-tight mb-2 leading-none">{d.name}</h3>
                                <p className="text-[10px] font-black text-primary uppercase mb-4 tracking-widest leading-none">Líder: {d.leader}</p>
                                <p className="text-xs text-gray-400 font-medium leading-relaxed">{d.description}</p>
                            </div>
                        ))}
                        {myDepts.length === 0 && <p className="col-span-full py-20 text-center text-gray-300 font-black uppercase text-xs border-2 border-dashed rounded-[3rem]">Você não participa de frentes de trabalho.</p>}
                    </div>
                </div>
            );
        }

        // Funções de Admin (Simplificadas para o HTML, mantendo lógica original)
        function DepartmentsAdmin({ departments, showToast }) {
            const [showAdd, setShowAdd] = useState(false);
            const [editing, setEditing] = useState(null);
            const [iconPreview, setIconPreview] = useState('');

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setIconPreview(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = async (e) => {
                e.preventDefault();
                const data = new FormData(e.target);
                const payload = { name: data.get('name'), leader: data.get('leader'), description: data.get('description'), color: data.get('color'), icon: iconPreview || editing?.icon || '' };
                if (editing) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'departments', editing.id), payload);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'departments'), payload);
                setEditing(null); setShowAdd(false); setIconPreview('');
                showToast("Salvo!");
            };

            return (
                <div className="space-y-6 text-gray-800">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-black uppercase">Frentes</h2><button onClick={() => { setShowAdd(true); setIconPreview(''); }} className="bg-primary text-white p-4 rounded-2xl font-black shadow-lg flex items-center gap-2"><Plus size={20}/> Novo</button></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {departments.map(d => (
                            <div key={d.id} className="bg-white p-6 rounded-[2rem] border shadow-sm flex items-center justify-between group">
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-2xl flex items-center justify-center overflow-hidden shadow-sm" style={{ backgroundColor: `${d.color}20`, color: d.color }}>
                                        {d.icon && typeof d.icon === 'string' && d.icon.startsWith('data:image') ? <img src={d.icon} className="w-full h-full object-cover" alt="Icon" /> : <Briefcase size={24}/>}
                                    </div>
                                    <div><h4 className="font-black uppercase text-sm">{d.name}</h4><p className="text-[10px] font-black text-gray-400 uppercase">Líder: {d.leader}</p></div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => { setEditing(d); setIconPreview(d.icon); }} className="p-2 text-gray-400 hover:text-primary transition"><Edit2 size={18}/></button>
                                    <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'departments', d.id))} className="p-2 text-gray-400 hover:text-red-500 transition"><Trash2 size={18}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                    {(showAdd || editing) && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <form onSubmit={handleSave} className="bg-white p-8 rounded-[3rem] w-full max-w-md space-y-4 shadow-2xl overflow-y-auto max-h-[90vh]">
                                <div className="flex flex-col items-center gap-4 py-2 border-b"><div className="w-20 h-20 rounded-3xl bg-gray-50 border-2 border-dashed border-gray-200 flex items-center justify-center relative overflow-hidden group">{iconPreview ? <img src={iconPreview} className="w-full h-full object-cover" alt="Preview" /> : <ImageIcon className="text-gray-300" />}<input type="file" onChange={handleFileChange} className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" /></div></div>
                                <input name="name" defaultValue={editing?.name} placeholder="Nome" required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none" /><input name="leader" defaultValue={editing?.leader} placeholder="Líder" required className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none" /><textarea name="description" defaultValue={editing?.description} placeholder="Descrição" className="w-full p-4 bg-gray-50 rounded-2xl font-medium outline-none h-24" /><input name="color" type="color" defaultValue={editing?.color || "#3b82f6"} className="w-full h-12 bg-transparent cursor-pointer" /><div className="flex gap-4 pt-4"><button type="button" onClick={() => {setShowAdd(false); setEditing(null); setIconPreview('');}} className="flex-1 text-xs font-black uppercase text-gray-400">Cancelar</button><button type="submit" className="flex-1 bg-primary text-white py-4 rounded-2xl font-black uppercase text-xs">Salvar</button></div>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        // --- APP PRINCIPAL ---
        function App() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [toast, setToast] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [settings, setSettings] = useState({ siteName: 'Portal Ministerial', primaryColor: '#3b82f6', loginTitle: 'Mídia ADPerus', loginBgColor: '#3b82f6' });
            const [allUsers, setAllUsers] = useState([]);
            const [events, setEvents] = useState([]);
            const [attendance, setAttendance] = useState([]);
            const [departments, setDepartments] = useState([]);
            const [authError, setAuthError] = useState('');
            const [isAuthProcessing, setIsAuthProcessing] = useState(false);

            const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => setToast(null), 3000); };

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (!u) { setUserProfile(null); setLoading(false); }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubProfile = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), (snap) => { if (snap.exists()) setUserProfile(snap.data()); setLoading(false); }, () => setLoading(false));
                const unsubSettings = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general'), (snap) => { if (snap.exists()) setSettings(snap.data()); });
                const unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), snap => setAllUsers(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubEvents = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'events'), snap => setEvents(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubAtt = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), snap => setAttendance(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubDepts = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'departments'), snap => setDepartments(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                return () => { unsubProfile(); unsubSettings(); unsubUsers(); unsubEvents(); unsubAtt(); unsubDepts(); };
            }, [user]);

            const handleLogout = async () => { await signOut(auth); setView('dashboard'); };

            if (loading && user) return <div className="h-screen flex items-center justify-center bg-gray-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div></div>;

            if (!user || !userProfile) return <AuthScreen settings={settings} error={authError} isProcessing={isAuthProcessing} 
                onLogin={async (e) => {
                    e.preventDefault(); setAuthError(''); setIsAuthProcessing(true);
                    const { name, password } = e.target.elements;
                    try {
                        const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
                        const uFound = snap.docs.map(d => d.data()).find(u => u.name?.trim().toLowerCase() === name.value.trim().toLowerCase());
                        if (!uFound) throw new Error();
                        await signInWithEmailAndPassword(auth, uFound.email, password.value);
                    } catch { setAuthError('Acesso Negado.'); } finally { setIsAuthProcessing(false); }
                }}
                onRegister={async (e) => {
                    e.preventDefault(); setAuthError(''); setIsAuthProcessing(true);
                    const { name, phone, unidadeType, regionalName, setorName, congregacaoName, password } = e.target.elements;
                    try {
                        const email = `${name.value.replace(/\s+/g, '').toLowerCase()}_${Date.now()}@portal.com`;
                        const res = await createUserWithEmailAndPassword(auth, email, password.value);
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', res.user.uid), {
                            uid: res.user.uid, name: name.value, email, phone: phone.value, unidadeType: unidadeType.value,
                            regionalName: regionalName?.value || "", setorName: setorName?.value || "", congregacaoName: congregacaoName?.value || "",
                            status: 'pending', role: 'user', isAdmin: false, isAvailable: true, joinDate: new Date().toISOString(), participatingDepts: []
                        });
                    } catch { setAuthError('Erro ao cadastrar.'); } finally { setIsAuthProcessing(false); }
                }}
                onAdminLogin={async (e) => {
                    e.preventDefault();
                    if (e.target.adminPassword.value === '123') {
                        setIsAuthProcessing(true);
                        try {
                            const cur = (await signInAnonymously(auth)).user;
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', cur.uid), { uid: cur.uid, name: "Admin Master", email: "master@portal.com", role: 'master', status: 'active', isAdmin: true, isAvailable: true, joinDate: new Date().toISOString(), participatingDepts: [] });
                        } catch { setAuthError('Erro.'); } finally { setIsAuthProcessing(false); }
                    } else setAuthError('Senha Inválida.');
                }}
            />;

            return (
                <div className="flex h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
                    <CustomStyles primaryColor={settings.primaryColor} />
                    {toast && <div className={`fixed bottom-8 right-8 z-[100] px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 animate-bounce ${toast.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}><span className="text-xs font-black uppercase">{toast.message}</span></div>}
                    
                    <aside className={`${isSidebarOpen ? 'w-64' : 'w-20'} bg-white border-r transition-all duration-300 flex flex-col z-30 no-print`}>
                        <div className="h-20 flex items-center px-6 border-b overflow-hidden gap-3 shrink-0">
                            <div className="w-10 h-10 rounded-xl bg-primary flex items-center justify-center text-white font-black shrink-0 shadow-lg">{settings.siteName.charAt(0)}</div>
                            {isSidebarOpen && <span className="font-bold text-lg truncate text-primary uppercase tracking-tighter">{settings.siteName}</span>}
                        </div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                            <NavItem active={view === 'dashboard'} icon={<LayoutDashboard />} label="Dashboard" onClick={() => setView('dashboard')} open={isSidebarOpen} />
                            <NavItem active={view === 'agenda'} icon={<BookOpen />} label="Agenda Ministerial" onClick={() => setView('agenda')} open={isSidebarOpen} />
                            <NavItem active={view === 'my_depts'} icon={<Layers />} label="Minhas Frentes" onClick={() => setView('my_depts')} open={isSidebarOpen} />
                            {userProfile.isAdmin && (
                                <div className="pt-6 border-t mt-4">
                                    <NavItem active={view === 'depts_admin'} icon={<Briefcase />} label="Gerenciar Frentes" onClick={() => setView('depts_admin')} open={isSidebarOpen} />
                                </div>
                            )}
                        </nav>
                        <div className="p-4 border-t"><button onClick={handleLogout} className="w-full flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 rounded-xl transition font-black text-[10px] uppercase"><LogOut size={20} /> {isSidebarOpen && "Sair"}</button></div>
                    </aside>

                    <main className="flex-1 flex flex-col min-w-0">
                        <header className="h-20 bg-white border-b px-8 flex items-center justify-between shrink-0 no-print">
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-gray-100 rounded-lg"><Menu size={20} /></button>
                            <div className="flex items-center gap-3">
                                <div className="text-right hidden sm:block"><p className="text-sm font-bold">{userProfile.name}</p><p className="text-[10px] text-gray-400 uppercase font-black">{userProfile.role}</p></div>
                                <div className="w-10 h-10 rounded-full bg-gray-100 border flex items-center justify-center text-gray-400"><UserCircle size={24} /></div>
                            </div>
                        </header>
                        <div className="flex-1 overflow-y-auto p-4 sm:p-8">
                            {view === 'dashboard' && <DashboardView userProfile={userProfile} attendance={attendance} events={events} />}
                            {view === 'agenda' && <AgendaView events={events} attendance={attendance} userProfile={userProfile} departments={departments} category="Agenda Ministerial" showToast={showToast} />}
                            {view === 'my_depts' && <UserDepartments departments={departments} userProfile={userProfile} />}
                            {view === 'depts_admin' && userProfile.isAdmin && <DepartmentsAdmin departments={departments} showToast={showToast} />}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
